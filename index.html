<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disparador PRO - Sistema de Automação WhatsApp</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .whatsapp-bg { background-color: #e5ddd5; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); opacity: 0.9; }
        .chat-bubble { position: relative; max-width: 80%; padding: 10px; border-radius: 8px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .chat-bubble::after { content: ''; position: absolute; top: 0; width: 0; height: 0; }
        .bubble-out { background: #dcf8c6; align-self: flex-end; border-top-right-radius: 0; margin-left: auto; }
        .bubble-out::after { right: -10px; top: 0; border-left: 10px solid #dcf8c6; border-bottom: 10px solid transparent; }
        
        /* Scrollbar customizada */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONFIGURAÇÃO DA EVOLUTION API ---
        // IMPORTANTE: Para funcionar, você precisa ter a Evolution API rodando na porta 8080
        const API_URL = "http://localhost:8080"; 
        // Esta chave deve ser a mesma configurada no arquivo .env da sua API (AUTHENTICATION_API_KEY)
        // Se você acabou de instalar a API, a chave padrão geralmente é gerada ou definida por você.
        const API_KEY = "B8974591B4F8175"; // <-- TROQUE PELA SUA API KEY REAL
        const INSTANCE_NAME = "disparador_pro"; 

        // --- Componentes de Ícone ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [contacts, setContacts] = useState([
                { id: 1, name: "Cliente Teste", phone: "5511999999999", status: "offline" }
            ]);
            const [connected, setConnected] = useState(false);
            const [messageTemplate, setMessageTemplate] = useState("Olá {{nome}}, confira nossa oferta!");
            const [campaignDelay, setCampaignDelay] = useState(10);
            const [isSending, setIsSending] = useState(false);
            const [progress, setProgress] = useState(0);
            const [logs, setLogs] = useState([]);
            const [connectionError, setConnectionError] = useState(null);

            useEffect(() => {
                checkConnection();
                // Tenta reconectar a cada 10 segundos se não estiver conectado
                const interval = setInterval(() => {
                    if (!connected) checkConnection();
                }, 10000);
                return () => clearInterval(interval);
            }, [connected]);

            const checkConnection = async () => {
                try {
                    // Tenta verificar status da instância
                    const response = await fetch(`${API_URL}/instance/connectionState/${INSTANCE_NAME}`, {
                        method: 'GET',
                        headers: { 'apikey': API_KEY }
                    });
                    
                    if (!response.ok) {
                        // Se der 404, a instância não existe
                        if (response.status === 404) {
                            setConnectionError("Instância não encontrada. Vá em 'Conexão' para criar.");
                            setConnected(false);
                            return;
                        }
                        // Se der 403, a chave API está errada
                        if (response.status === 403) {
                            setConnectionError("Erro de Autenticação: Verifique sua API KEY no código.");
                            setConnected(false);
                            return;
                        }
                        throw new Error("Erro na API");
                    }

                    const data = await response.json();
                    if (data.instance && data.instance.state === 'open') {
                        setConnected(true);
                        setConnectionError(null);
                    } else {
                        setConnected(false);
                    }
                } catch (error) {
                    console.error("API Offline ou Bloqueada:", error);
                    setConnectionError("Não foi possível contatar a API (localhost:8080). Verifique se ela está rodando.");
                    setConnected(false);
                }
            };

            const startCampaign = async () => {
                if (!connected) {
                    alert("Erro: O WhatsApp não está conectado.");
                    setActiveTab('connection');
                    return;
                }
                
                setIsSending(true);
                setProgress(0);
                let sentCount = 0;
                const total = contacts.length;

                for (let i = 0; i < total; i++) {
                    const contact = contacts[i];
                    let finalMessage = messageTemplate.replace(/{{nome}}/gi, contact.name);
                    let cleanPhone = contact.phone.replace(/\D/g, '');

                    try {
                        const response = await fetch(`${API_URL}/message/sendText/${INSTANCE_NAME}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': API_KEY
                            },
                            body: JSON.stringify({
                                number: cleanPhone,
                                text: finalMessage,
                                delay: 1200,
                                linkPreview: true
                            })
                        });

                        const result = await response.json();
                        
                        if (response.status === 201 || result.key) {
                             setLogs(prev => [{ time: new Date().toLocaleTimeString(), action: `Enviado: ${contact.name}`, type: 'success' }, ...prev]);
                        } else {
                             throw new Error(result.message || "Erro API");
                        }

                    } catch (error) {
                        setLogs(prev => [{ time: new Date().toLocaleTimeString(), action: `Falha: ${contact.name}`, type: 'error' }, ...prev]);
                    }

                    sentCount++;
                    setProgress((sentCount / total) * 100);

                    if (i < total - 1) {
                        await new Promise(resolve => setTimeout(resolve, campaignDelay * 1000));
                    }
                }

                setIsSending(false);
                alert("Campanha finalizada!");
            };

            // Renderização Condicional das Abas
            const renderContent = () => {
                switch(activeTab) {
                    case 'dashboard': return <Dashboard stats={{ contacts: contacts.length }} logs={logs} connected={connected} error={connectionError} />;
                    case 'connection': return <Connection connected={connected} setConnected={setConnected} API_URL={API_URL} API_KEY={API_KEY} INSTANCE_NAME={INSTANCE_NAME} />;
                    case 'contacts': return <ContactsManager contacts={contacts} setContacts={setContacts} />;
                    case 'campaign': return <CampaignBuilder template={messageTemplate} setTemplate={setMessageTemplate} contacts={contacts} delay={campaignDelay} setDelay={setCampaignDelay} onSend={startCampaign} isSending={isSending} progress={progress} />;
                    default: return <Dashboard />;
                }
            };

            return (
                <div className="flex h-screen w-full bg-gray-100 text-gray-800 overflow-hidden">
                    {/* Sidebar */}
                    <aside className="w-20 lg:w-64 bg-white border-r border-gray-200 flex flex-col justify-between z-20 shadow-sm">
                        <div>
                            <div className="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-gray-100 cursor-pointer" onClick={() => setActiveTab('dashboard')}>
                                <div className="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center text-white font-bold mr-0 lg:mr-3">D</div>
                                <span className="font-bold text-xl hidden lg:block text-gray-800">Disparador<span className="text-green-600">Pro</span></span>
                            </div>
                            <nav className="mt-6 flex flex-col gap-2 px-3">
                                <SidebarItem icon="layout-dashboard" label="Dashboard" active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} />
                                <SidebarItem icon="smartphone" label="Conexão" active={activeTab === 'connection'} onClick={() => setActiveTab('connection')} />
                                <SidebarItem icon="users" label="Contatos" active={activeTab === 'contacts'} onClick={() => setActiveTab('contacts')} />
                                <SidebarItem icon="send" label="Campanha" active={activeTab === 'campaign'} onClick={() => setActiveTab('campaign')} />
                            </nav>
                        </div>
                        <div className="p-4 border-t">
                            <div className={`flex items-center gap-3 p-3 rounded-xl ${connected ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'} border`}>
                                <div className={`w-3 h-3 rounded-full ${connected ? 'bg-green-500' : 'bg-red-500'} animate-pulse`}></div>
                                <div className="hidden lg:block">
                                    <p className="text-[10px] font-bold text-gray-400 uppercase">Status</p>
                                    <p className={`text-sm font-bold ${connected ? 'text-green-700' : 'text-red-700'}`}>{connected ? 'Online' : 'Offline'}</p>
                                </div>
                            </div>
                        </div>
                    </aside>
                    <main className="flex-1 overflow-auto bg-[#F8FAFC] p-4 lg:p-8">
                        {renderContent()}
                    </main>
                </div>
            );
        };

        const SidebarItem = ({ icon, label, active, onClick }) => (
            <button onClick={onClick} className={`flex items-center w-full p-3 rounded-lg transition-all ${active ? 'bg-green-50 text-green-700 ring-1 ring-green-100' : 'text-gray-500 hover:bg-white hover:shadow-sm'}`}>
                <Icon name={icon} className={`${active ? 'stroke-green-600' : 'stroke-gray-400'}`} />
                <span className="ml-3 font-medium hidden lg:block text-sm">{label}</span>
            </button>
        );

        const Dashboard = ({ stats, connected, logs = [], error }) => (
            <div className="space-y-6 animate-fade-in pb-10">
                <h1 className="text-2xl font-bold text-gray-800">Visão Geral</h1>
                
                {error && (
                    <div className="bg-red-50 border-l-4 border-red-500 p-4 rounded-r shadow-sm">
                        <div className="flex">
                            <div className="flex-shrink-0"><Icon name="alert-circle" className="text-red-500" /></div>
                            <div className="ml-3"><p className="text-sm text-red-700 font-bold">{error}</p></div>
                        </div>
                    </div>
                )}

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                        <p className="text-gray-500 text-xs font-bold uppercase">Contatos</p>
                        <h4 className="text-2xl font-bold">{stats?.contacts || 0}</h4>
                    </div>
                    <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                        <p className="text-gray-500 text-xs font-bold uppercase">Envios Hoje</p>
                        <h4 className="text-2xl font-bold">{logs.length}</h4>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h3 className="font-semibold text-gray-800 mb-4">Log de Envios</h3>
                    <div className="space-y-3 max-h-60 overflow-y-auto">
                        {logs.length === 0 ? <p className="text-gray-400 text-sm">Nenhuma atividade.</p> : logs.map((log, i) => (
                            <div key={i} className="flex items-center gap-3 text-sm pb-2 border-b last:border-0">
                                <span className={`w-2 h-2 rounded-full ${log.type === 'success' ? 'bg-green-500' : 'bg-red-500'}`}></span>
                                <span className="text-gray-500 font-mono text-xs">{log.time}</span>
                                <span className="font-medium text-gray-700">{log.action}</span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        const Connection = ({ connected, setConnected, API_URL, API_KEY, INSTANCE_NAME }) => {
            const [qrCode, setQrCode] = useState(null);
            const [loading, setLoading] = useState(false);

            const handleConnect = async () => {
                setLoading(true);
                setQrCode(null);
                try {
                    // 1. Tenta criar instância
                    const createRes = await fetch(`${API_URL}/instance/create`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'apikey': API_KEY },
                        body: JSON.stringify({ instanceName: INSTANCE_NAME, qrcode: true })
                    });
                    const createData = await createRes.json();
                    
                    if (createData.qrcode && createData.qrcode.base64) {
                        setQrCode(createData.qrcode.base64); // V1 response
                    } else if (createData.base64) {
                        setQrCode(createData.base64); // V2 response
                    }

                    // Se já existe, tenta conectar
                    if (createRes.status === 403 || (createData.error && createData.error.includes("already exists"))) {
                        const connectRes = await fetch(`${API_URL}/instance/connect/${INSTANCE_NAME}`, {
                             headers: { 'apikey': API_KEY }
                        });
                        const connectData = await connectRes.json();
                        if (connectData.base64) setQrCode(connectData.base64);
                    }

                } catch (e) {
                    alert("Erro ao conectar API. Verifique se o servidor está rodando na porta 8080.");
                } finally {
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                if(!confirm("Desconectar WhatsApp?")) return;
                try {
                    await fetch(`${API_URL}/instance/logout/${INSTANCE_NAME}`, { method: 'DELETE', headers: { 'apikey': API_KEY } });
                    setConnected(false);
                } catch(e) { console.error(e); }
            };

            return (
                <div className="flex flex-col items-center justify-center h-full bg-white rounded-xl shadow-sm border p-8">
                    <h2 className="text-2xl font-bold mb-4">Conexão WhatsApp</h2>
                    
                    {connected ? (
                        <div className="text-center">
                            <div className="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <Icon name="check" size={40} />
                            </div>
                            <h3 className="text-green-700 font-bold text-xl">Conectado!</h3>
                            <button onClick={handleLogout} className="mt-6 text-red-500 underline text-sm">Desconectar</button>
                        </div>
                    ) : (
                        <div className="text-center w-full max-w-md">
                             {!qrCode ? (
                                <button onClick={handleConnect} disabled={loading} className="bg-green-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-green-700 flex items-center gap-2 mx-auto">
                                    {loading ? <Icon name="loader-2" className="animate-spin" /> : <Icon name="qr-code" />}
                                    {loading ? "Gerando..." : "Gerar QR Code"}
                                </button>
                             ) : (
                                 <div className="flex flex-col items-center">
                                     <p className="mb-2 font-bold">Leia o QR Code:</p>
                                     <img src={qrCode} className="w-64 h-64 border-2 border-gray-800 rounded-lg" />
                                     <button onClick={() => setQrCode(null)} className="mt-4 text-gray-400 text-sm">Cancelar</button>
                                 </div>
                             )}
                        </div>
                    )}
                </div>
            );
        };

        const ContactsManager = ({ contacts, setContacts }) => {
            const [name, setName] = useState("");
            const [phone, setPhone] = useState("");
            const add = (e) => {
                e.preventDefault();
                if(name && phone) {
                    setContacts([...contacts, { id: Date.now(), name, phone, status: 'offline' }]);
                    setName(""); setPhone("");
                }
            };
            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in">
                    <div className="bg-white p-6 rounded-xl border shadow-sm h-fit">
                        <h3 className="font-bold mb-4">Novo Contato</h3>
                        <form onSubmit={add} className="space-y-3">
                            <input value={name} onChange={e=>setName(e.target.value)} placeholder="Nome" className="w-full border p-2 rounded" />
                            <input value={phone} onChange={e=>setPhone(e.target.value)} placeholder="5511999999999" className="w-full border p-2 rounded" />
                            <button className="w-full bg-green-600 text-white p-2 rounded font-bold">Adicionar</button>
                        </form>
                    </div>
                    <div className="lg:col-span-2 bg-white rounded-xl border shadow-sm p-4">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-gray-50 text-gray-500 uppercase"><tr><th className="p-3">Nome</th><th className="p-3">Telefone</th><th className="p-3">Ação</th></tr></thead>
                            <tbody>
                                {contacts.map(c => (
                                    <tr key={c.id} className="border-b last:border-0 hover:bg-gray-50">
                                        <td className="p-3 font-medium">{c.name}</td>
                                        <td className="p-3 font-mono text-gray-500">{c.phone}</td>
                                        <td className="p-3"><button onClick={() => setContacts(contacts.filter(x => x.id !== c.id))} className="text-red-400 hover:text-red-600"><Icon name="trash-2" size={16}/></button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const CampaignBuilder = ({ template, setTemplate, contacts, delay, setDelay, onSend, isSending, progress }) => (
            <div className="flex flex-col lg:flex-row gap-6 animate-fade-in h-full">
                <div className="flex-1 bg-white p-6 rounded-xl shadow-sm border space-y-4">
                    <h2 className="text-xl font-bold">Criar Campanha</h2>
                    <div>
                        <label className="text-sm font-bold text-gray-500">Mensagem</label>
                        <textarea value={template} onChange={e => setTemplate(e.target.value)} className="w-full h-32 border p-3 rounded-lg mt-1 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Olá {{nome}}..." />
                        <p className="text-xs text-gray-400 mt-1">Use <strong>{{nome}}</strong> para personalizar.</p>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="text-xs font-bold uppercase text-gray-500">Delay (seg)</label><input type="number" value={delay} onChange={e => setDelay(e.target.value)} className="w-full border p-2 rounded mt-1" /></div>
                        <div><label className="text-xs font-bold uppercase text-gray-500">Alcance</label><div className="p-2 bg-gray-100 rounded mt-1 text-gray-600">{contacts.length} contatos</div></div>
                    </div>
                    {isSending ? (
                        <div className="bg-gray-100 p-4 rounded-lg">
                            <div className="flex justify-between mb-2 text-xs font-bold"><span>Enviando...</span><span>{Math.round(progress)}%</span></div>
                            <div className="h-2 bg-gray-300 rounded-full overflow-hidden"><div style={{width: `${progress}%`}} className="h-full bg-green-500 transition-all"></div></div>
                        </div>
                    ) : (
                        <button onClick={onSend} className="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 shadow-lg shadow-green-200">Iniciar Disparos</button>
                    )}
                </div>
                <div className="w-full lg:w-80 flex justify-center pt-4">
                    <div className="w-[280px] h-[550px] bg-black rounded-[2.5rem] p-3 shadow-2xl relative border-4 border-gray-800">
                        <div className="w-full h-full bg-[#e5ddd5] rounded-[2rem] overflow-hidden flex flex-col relative">
                            <div className="bg-[#075e54] h-14 flex items-center px-4 text-white shadow"><span className="font-bold text-sm">Pré-visualização</span></div>
                            <div className="p-4"><div className="bg-[#dcf8c6] p-2 rounded-lg text-sm shadow text-gray-800">{template.replace(/{{nome}}/gi, contacts[0]?.name || "Cliente")}</div></div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
