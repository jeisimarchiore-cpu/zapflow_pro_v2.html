<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZapFlow Pro V2 - Flow Minimalista</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Recharts (Gr√°ficos) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.js"></script>

    <!-- FIREBASE/FIRESTORE IMPORTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Importando todas as fun√ß√µes separadamente e anexando-as ao window (solu√ß√£o tempor√°ria para CDN/Babel)
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, writeBatch, deleteDoc, setLogLevel, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // CONFIGURA√á√ÉO REAL DO USU√ÅRIO (controle-de-igrejas)
        const firebaseConfig = {
            apiKey: "AIzaSyDXmAZ-VW7Ti1_L5GPW0gNBkfGxMmxvypQ",
            authDomain: "controle-de-igrejas.firebaseapp.com",
            projectId: "controle-de-igrejas",
            storageBucket: "controle-de-igrejas.firebasestorage.app",
            messagingSenderId: "457376397325",
            appId: "1:457376397325:web:aacc6cef3e91390314fd44",
            measurementId: "G-PENC7PPT4M"
        };
        
        // Usando o projectId como ID √∫nico
        const appId = firebaseConfig.projectId || 'default-zapflow-app'; 

        // Inicializa√ß√£o global de Firebase
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);
        window.appId = appId;
        
        // Expondo as fun√ß√µes principais do Firebase para o escopo global do Babel
        window.onAuthStateChanged = onAuthStateChanged;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.deleteDoc = deleteDoc;
        window.writeBatch = writeBatch;
        window.updateDoc = updateDoc;
        
        // Debugging Firestore
        setLogLevel('debug');
        
        // Autentica√ß√£o usando signInAnonymously
        const authenticate = async () => {
            try {
                // Removemos o uso de initialAuthToken, usamos login an√¥nimo
                await signInAnonymously(window.auth); 
                console.log("Firebase Authenticated successfully.");
            } catch (error) {
                console.error("Firebase Authentication Error (Anonymous):", error);
            }
        };

        window.authenticate = authenticate;
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; } 
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .iphone-preview {
            border: 8px solid #0f172a;
            border-radius: 36px;
            overflow: hidden;
            position: relative;
            background-color: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-top: 24px solid #0f172a; 
            border-bottom: 8px solid #0f172a;
        }

        .iphone-preview::before {
            content: '';
            position: absolute;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 20px;
            background-color: #0f172a;
            border-radius: 0 0 10px 10px;
            z-index: 10;
        }

        .chat-bg {
            background-color: #e5ddd5;
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            opacity: 0.95;
            background-blend-mode: overlay;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- Componente de √çcone Lucide ---
        const Icon = ({ name, size = 20, className = "" }) => {
            return <i data-lucide={name} className={className} style={{ width: size, height: size, minWidth: size, minHeight: size }}></i>;
        };

        // --- Componente de Modal (Geral) ---
        const Modal = ({ title, message, isOpen, onClose, footer=null }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all">
                        <h3 className="text-xl font-bold mb-3 text-gray-800 flex items-center gap-2">
                            <Icon name="info" size={24} className="text-emerald-500"/>
                            {title}
                        </h3>
                        <div className="text-gray-600 mb-6 text-sm">
                            {typeof message === 'object' ? message : <p>{message}</p>}
                        </div>
                        {footer || (
                             <button
                                onClick={onClose}
                                className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2 rounded-lg transition"
                            >
                                Fechar
                            </button>
                        )}
                    </div>
                </div>
            );
        };
        
        // Componente de Detalhe de Contato (Dashboard e Tabela)
        const ContactDetailModal = ({ contact, isOpen, onClose }) => {
            if (!isOpen || !contact) return null;

            const lastSentDate = new Date(contact.lastSent || Date.now());
            const timeAgo = lastSentDate.toLocaleTimeString('pt-BR');

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg transform transition-all">
                        <h3 className="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                            <Icon name="scan-line" size={28} className="text-blue-600"/>
                            M√©tricas de {contact.name.split(' ')[0]}
                        </h3>
                        
                        <div className="space-y-4 mb-6">
                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 flex justify-between items-center">
                                <div>
                                    <p className="text-lg font-bold">{contact.name}</p>
                                    <p className="text-sm text-gray-600 font-mono">{contact.number}</p>
                                </div>
                                <span className={`px-3 py-1 rounded-full text-xs font-medium ${contact.status === 'Ativo' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {contact.status}
                                </span>
                            </div>

                            <div className="grid grid-cols-3 gap-4 text-center">
                                <div className="p-3 bg-blue-50 rounded-lg text-sm">
                                    <p className="font-medium text-gray-700">Total Ano</p>
                                    <p className="font-bold text-xl text-blue-800">{contact.sentYear}</p>
                                </div>
                                <div className="p-3 bg-yellow-50 rounded-lg text-sm">
                                    <p className="font-medium text-gray-700">Bloqueios</p>
                                    <p className="font-bold text-xl text-yellow-800">{contact.blockedCount}</p>
                                </div>
                                <div className="p-3 bg-emerald-50 rounded-lg text-sm">
                                    <p className="font-medium text-gray-700">Respostas</p>
                                    <p className="font-bold text-xl text-emerald-800">{contact.lastSentReplied ? 'Sim' : 'N√£o'}</p>
                                </div>
                            </div>

                            <h4 className="font-semibold text-gray-700 mt-6 pt-4 border-t">Rastreamento da √öltima Mensagem ({timeAgo})</h4>
                            
                            <div className="space-y-3">
                                <div className="flex justify-between items-center text-base p-2 rounded-lg bg-white shadow-sm border border-gray-100">
                                    <span className="flex items-center gap-2 text-gray-600"><Icon name="message-square" size={18}/> Enviada:</span>
                                    <span className="font-bold text-green-600">‚úÖ SIM</span>
                                </div>
                                <div className="flex justify-between items-center text-base p-2 rounded-lg bg-white shadow-sm border border-gray-100">
                                    <span className="flex items-center gap-2 text-gray-600"><Icon name="eye" size={18}/> Visualizada:</span>
                                    <span className={`font-bold ${contact.lastSentViewed ? 'text-green-600' : 'text-gray-500'}`}>
                                        {contact.lastSentViewed ? '‚úÖ SIM' : '‚è≥ PENDENTE'}
                                    </span>
                                </div>
                                <div className="flex justify-between items-center text-base p-2 rounded-lg bg-white shadow-sm border border-gray-100">
                                    <span className="flex items-center gap-2 text-gray-600"><Icon name="reply" size={18}/> Respondeu:</span>
                                    <span className={`font-bold ${contact.lastSentReplied ? 'text-blue-600' : 'text-red-600'}`}>
                                        {contact.lastSentReplied ? 'üí¨ SIM' : '‚ùå N√ÉO'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <button
                            onClick={onClose}
                            className="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 rounded-lg transition mt-4"
                        >
                            Fechar
                        </button>
                    </div>
                </div>
            );
        };

        // Componente de Gerenciamento de Lista
        const ListManagementModal = ({ list, contacts, isOpen, onClose, onListDelete }) => {
            if (!isOpen || !list) return null;

            const listContacts = contacts.filter(c => list.contactIds.includes(c.id));
            const [listName, setListName] = useState(list.name);

            // Simula√ß√£o de A√ß√£o
            const handleSave = async () => {
                const db = window.db;
                const appId = window.appId;
                const userId = window.auth?.currentUser?.uid || 'anonymous';
                
                if (listName.trim() === '') {
                    // Substituindo alert por showModal
                    window.showModal("Erro de Edi√ß√£o", "O nome da lista n√£o pode estar vazio.");
                    return;
                }
                
                try {
                    const listRef = window.doc(db, `artifacts/${appId}/users/${userId}/contactLists`, list.id.toString());
                    await window.setDoc(listRef, { name: listName, contactIds: list.contactIds }, { merge: true });
                    window.showModal("Sucesso", `Lista '${list.name}' salva com sucesso.`);
                    onClose();
                } catch (e) {
                    window.showModal("Erro de Persist√™ncia", "Erro ao salvar lista: " + e.message);
                }
            };

            const handleDeleteList = async () => { 
                if (window.confirm(`Tem certeza que deseja excluir a lista: ${list.name}? Esta a√ß√£o √© irrevers√≠vel.`)) {
                    try {
                        const db = window.db;
                        const appId = window.appId;
                        const userId = window.auth?.currentUser?.uid || 'anonymous';
                        const listRef = window.doc(db, `artifacts/${appId}/users/${userId}/contactLists`, list.id.toString());
                        await window.deleteDoc(listRef);
                        window.showModal("Sucesso", `Lista '${list.name}' exclu√≠da com sucesso.`);
                        onListDelete(list.id);
                        onClose();
                    } catch (e) {
                        window.showModal("Erro de Persist√™ncia", "Erro ao excluir lista: " + e.message);
                    }
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-3xl transform transition-all">
                        <h3 className="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                            <Icon name="list-checks" size={28} className="text-blue-600"/>
                            Gerenciar Lista: <span className="text-blue-700">{list.name}</span>
                        </h3>

                        <div className="space-y-6">
                            <div className="bg-gray-50 p-4 rounded-xl border border-gray-200">
                                <h4 className="font-semibold text-gray-700 mb-3">Configura√ß√µes B√°sicas</h4>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Nome da Lista</label>
                                <input
                                    type="text"
                                    value={listName}
                                    onChange={(e) => setListName(e.target.value)}
                                    className="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none"
                                />
                                <div className="mt-4 flex justify-between items-center text-sm">
                                    <span className="text-gray-600">ID da Lista: {list.id}</span>
                                    <span className="font-bold text-lg text-blue-700">{listContacts.length} Contatos</span>
                                </div>
                            </div>
                            <div>
                                <h4 className="font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                    <Icon name="users" size={18}/> Membros da Lista ({listContacts.length})
                                </h4>
                                <div className="max-h-60 overflow-y-auto border border-gray-200 rounded-xl">
                                    <table className="w-full text-left border-collapse">
                                        <thead className="bg-gray-100 text-gray-600 text-xs uppercase sticky top-0">
                                            <tr>
                                                <th className="p-3 font-medium">Nome</th>
                                                <th className="p-3 font-medium">N√∫mero</th>
                                                <th className="p-3 font-medium">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100 text-sm">
                                            {listContacts.map(c => (
                                                <tr key={c.id}>
                                                    <td className="p-3 font-medium">{c.name}</td>
                                                    <td className="p-3 text-gray-600 font-mono">{c.number}</td>
                                                    <td className="p-3">
                                                        <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                                            c.status === 'Ativo' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'
                                                        }`}>{c.status}</span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {listContacts.length === 0 && (
                                        <p className="p-4 text-center text-gray-500 text-sm">Nenhum contato nesta lista.</p>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="mt-8 pt-4 border-t border-gray-200 flex justify-between items-center">
                            <button 
                                className="text-red-600 hover:text-red-800 text-sm font-medium flex items-center gap-1 transition"
                                onClick={handleDeleteList}
                            >
                                <Icon name="trash-2" size={16}/> Excluir Lista
                            </button>
                            <div className="flex gap-3">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 rounded-full font-medium text-gray-600 transition border border-gray-300 hover:bg-gray-100"
                                >
                                    Cancelar
                                </button>
                                <button
                                    onClick={handleSave}
                                    className="px-4 py-2 rounded-full font-bold text-white transition bg-blue-600 hover:bg-blue-700 shadow-lg"
                                >
                                    Salvar Altera√ß√µes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Componente de Pr√©-visualiza√ß√£o de Importa√ß√£o (CSV)
        const ImportPreviewModal = ({ stagedData, contactLists, isOpen, onClose, onConfirmImport }) => {
            const [data, setData] = useState(stagedData);
            const [targetListId, setTargetListId] = useState(contactLists[0]?.id || null);

            useEffect(() => {
                setData(stagedData);
            }, [stagedData]);

            const validateContact = (contact) => {
                const number = contact.number.replace(/\D/g, ''); 
                const isValidNumber = number.length >= 10 && number.length <= 13 && number.startsWith('55');
                const isValidName = contact.name.trim().length > 0;
                return isValidNumber && isValidName;
            };

            const handleDataChange = (index, field, value) => {
                const newData = [...data];
                newData[index] = { ...newData[index], [field]: value };
                newData[index].isValid = validateContact(newData[index]); 
                setData(newData);
            };

            const totalValid = data.filter(c => c.isValid).length;
            const totalErrors = data.length - totalValid;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-5xl transform transition-all overflow-hidden">
                        <h3 className="text-2xl font-bold mb-4 text-gray-800 flex items-center gap-2 border-b pb-2">
                            <Icon name="scan" size={28} className="text-emerald-600"/>
                            Pr√©-visualiza√ß√£o e Valida√ß√£o de Importa√ß√£o CSV
                        </h3>

                        <div className="grid grid-cols-3 gap-6 mb-4">
                            <div className="p-3 bg-blue-50 rounded-lg">
                                <p className="text-sm font-medium text-gray-700">Contatos no Arquivo</p>
                                <p className="text-2xl font-bold text-blue-700">{data.length}</p>
                            </div>
                            <div className="p-3 bg-emerald-50 rounded-lg">
                                <p className="text-sm font-medium text-gray-700">Prontos para Importar</p>
                                <p className="text-2xl font-bold text-emerald-700">{totalValid}</p>
                            </div>
                            <div className="p-3 bg-red-50 rounded-lg">
                                <p className="text-sm font-medium text-gray-700">Com Erros / Ignorados</p>
                                <p className="text-2xl font-bold text-red-700">{totalErrors}</p>
                            </div>
                        </div>

                        {/* Configura√ß√£o de Lista */}
                        <div className="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-xl flex items-center justify-between">
                             <div className="flex items-center gap-2">
                                <Icon name="list-checks" size={20} className="text-blue-600"/>
                                <label className="text-sm font-medium text-gray-700">Vincular Contatos √† Lista:</label>
                             </div>
                            <select
                                value={targetListId || ''}
                                onChange={(e) => setTargetListId(e.target.value)} 
                                className="border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-white w-1/2"
                            >
                                {contactLists.map(list => (
                                    <option key={list.id} value={list.id}>
                                        {list.name}
                                    </option>
                                ))}
                            </select>
                        </div>
                        
                        {/* Tabela de Preview */}
                        <div className="max-h-[50vh] overflow-y-auto border border-gray-300 rounded-xl shadow-inner">
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-gray-100 text-gray-600 text-xs uppercase sticky top-0 z-10">
                                    <tr>
                                        <th className="p-3 font-semibold w-1/4">Nome (Edit√°vel)</th>
                                        <th className="p-3 font-semibold w-1/4">N√∫mero (Edit√°vel)</th>
                                        <th className="p-3 font-semibold w-1/4">Variavel 1</th>
                                        <th className="p-3 font-semibold w-1/4 text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200 text-sm">
                                    {data.map((contact, index) => (
                                        <tr key={index} className={contact.isValid ? 'bg-white' : 'bg-red-50'}>
                                            <td className="p-3">
                                                <input
                                                    type="text"
                                                    value={contact.name}
                                                    onChange={(e) => handleDataChange(index, 'name', e.target.value)}
                                                    className="w-full border-b border-gray-200 focus:border-blue-400 outline-none bg-transparent"
                                                />
                                            </td>
                                            <td className="p-3">
                                                <input
                                                    type="text"
                                                    value={contact.number}
                                                    onChange={(e) => handleDataChange(index, 'number', e.target.value)}
                                                    className="w-full border-b border-gray-200 focus:border-blue-400 outline-none bg-transparent font-mono"
                                                />
                                            </td>
                                            <td className="p-3 text-gray-500">
                                                {contact.variable1 || 'N/A'}
                                            </td>
                                            <td className="p-3 text-center">
                                                <span className={`px-2 py-1 rounded-full text-xs font-medium ${contact.isValid ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>
                                                    {contact.isValid ? 'V√ÅLIDO' : 'ERRO'}
                                                </span>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {/* Footer de A√ß√µes */}
                        <div className="mt-8 pt-4 border-t border-gray-200 flex justify-between items-center">
                            <button 
                                onClick={onClose}
                                className="px-6 py-3 rounded-full font-medium text-gray-600 transition border border-gray-300 hover:bg-gray-100"
                            >
                                Cancelar
                            </button>
                            <button
                                onClick={() => onConfirmImport(data, targetListId)}
                                disabled={totalValid === 0 || !targetListId}
                                className={`px-6 py-3 rounded-full font-bold text-white transition shadow-lg flex items-center gap-2 ${totalValid === 0 ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}
                            >
                                <Icon name="database" size={18}/> Importar {totalValid} Contatos
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Componente de Colar em Massa
        const BulkPasteModal = ({ contactLists, isOpen, onClose, onConfirmImport }) => {
            const [namesInput, setNamesInput] = useState('');
            const [numbersInput, setNumbersInput] = useState('');
            const [stagedData, setStagedData] = useState([]);

            const isPhoneNumberValid = (number) => {
                const cleaned = number ? number.toString().replace(/\D/g, '') : '';
                return cleaned.length >= 10 && cleaned.length <= 13 && cleaned.startsWith('55');
            };

            useEffect(() => {
                const names = namesInput.split('\n').map(s => s.trim()).filter(s => s.length > 0);
                const numbers = numbersInput.split('\n').map(s => s.trim()).filter(s => s.length > 0);
                
                const maxLength = Math.max(names.length, numbers.length);
                const newData = [];

                for (let i = 0; i < maxLength; i++) {
                    const name = names[i] || '';
                    const number = numbers[i] || '';
                    
                    if (name.length === 0 && number.length === 0) continue;
                    
                    const isValid = isPhoneNumberValid(number) && name.length > 0;

                    const contact = {
                        name: name,
                        number: number,
                        variable1: '', 
                        isValid: isValid,
                    };
                    if(name.length > 0 || number.length > 0) {
                        newData.push(contact);
                    }
                }
                setStagedData(newData);
            }, [namesInput, numbersInput]);
            
            const totalValid = stagedData.filter(c => c.isValid).length;
            const totalCount = stagedData.length;
            const totalErrors = totalCount - totalValid;
            const hasData = stagedData.length > 0;
            
            const [targetListId, setTargetListId] = useState(contactLists[0]?.id || null);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-5xl transform transition-all overflow-hidden">
                        <h3 className="text-2xl font-bold mb-6 text-gray-800 flex items-center gap-2 border-b pb-2">
                            <Icon name="clipboard-list" size={28} className="text-blue-600"/>
                            Colar em Massa (Nomes e N√∫meros)
                        </h3>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* Colunas de Entrada */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-1">
                                    <Icon name="type" size={16}/> Coluna de Nomes (Um nome por linha)
                                </label>
                                <textarea
                                    value={namesInput}
                                    onChange={(e) => setNamesInput(e.target.value)}
                                    placeholder="Copie a coluna de nomes do seu Excel/Planilha e cole aqui (um nome por linha)."
                                    className="w-full border border-gray-300 rounded-xl p-3 h-48 focus:ring-2 focus:ring-blue-500 outline-none resize-none text-sm"
                                ></textarea>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-1">
                                    <Icon name="phone" size={16}/> Coluna de N√∫meros (Um n√∫mero por linha - Formato 55XX9XXXXXXXX)
                                </label>
                                <textarea
                                    value={numbersInput}
                                    onChange={(e) => setNumbersInput(e.target.value)}
                                    placeholder="Copie a coluna de n√∫meros (na mesma ordem) e cole aqui."
                                    className="w-full border border-gray-300 rounded-xl p-3 h-48 focus:ring-2 focus:ring-blue-500 outline-none resize-none font-mono text-sm"
                                ></textarea>
                            </div>
                        </div>

                        {/* Status de Pr√©-visualiza√ß√£o */}
                        {hasData && (
                            <div className="mt-6">
                                <p className="text-sm font-bold text-gray-700 mb-2">Resumo da Valida√ß√£o:</p>
                                <div className="grid grid-cols-3 gap-4">
                                    <div className="p-3 bg-blue-50 rounded-lg">
                                        <p className="text-sm font-medium text-gray-700">Linhas Lidas</p>
                                        <p className="text-2xl font-bold text-blue-700">{totalCount}</p>
                                    </div>
                                    <div className="p-3 bg-emerald-50 rounded-lg">
                                        <p className="text-sm font-medium text-gray-700">Contatos V√°lidos</p>
                                        <p className="text-2xl font-bold text-emerald-700">{totalValid}</p>
                                    </div>
                                    <div className="p-3 bg-red-50 rounded-lg">
                                        <p className="text-sm font-medium text-gray-700">Linhas Ignoradas</p>
                                        <p className="text-2xl font-bold text-red-700">{totalErrors}</p>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* Tabela de Preview para confer√™ncia da sequ√™ncia */}
                        {hasData && (
                            <div className="mt-6 max-h-40 overflow-y-auto border border-gray-300 rounded-xl shadow-inner">
                                <table className="w-full text-left border-collapse">
                                    <thead className="bg-gray-100 text-gray-600 text-xs uppercase sticky top-0 z-10">
                                        <tr>
                                            <th className="p-3 font-semibold w-1/2">Nome</th>
                                            <th className="p-3 font-semibold w-1/2">N√∫mero</th>
                                            <th className="p-3 font-semibold w-1/6 text-center">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200 text-sm">
                                        {stagedData.slice(0, 10).map((contact, index) => (
                                            <tr key={index} className={contact.isValid ? 'bg-white' : 'bg-red-50'}>
                                                <td className="p-3">{contact.name || '- Vazio -'}</td>
                                                <td className="p-3 font-mono">{contact.number || '- Vazio -'}</td>
                                                <td className="p-3 text-center">
                                                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${contact.isValid ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>
                                                        {contact.isValid ? 'OK' : 'ERRO'}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                <p className="p-2 text-xs text-center text-gray-500 border-t">
                                    Apenas as 10 primeiras linhas s√£o exibidas. Total de linhas para importa√ß√£o: {totalCount}
                                </p>
                            </div>
                        )}


                        {/* Configura√ß√£o de Lista */}
                        <div className="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-xl flex items-center justify-between">
                             <div className="flex items-center gap-2">
                                <Icon name="list-checks" size={20} className="text-blue-600"/>
                                <label className="text-sm font-medium text-gray-700">Vincular Contatos √† Lista:</label>
                             </div>
                            <select
                                value={targetListId || ''}
                                onChange={(e) => setTargetListId(e.target.value)} // Corrigido para n√£o usar parseInt
                                className="border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-white w-1/3"
                            >
                                {contactLists.map(list => (
                                    <option key={list.id} value={list.id}>
                                        {list.name}
                                    </option>
                                ))}
                            </select>
                        </div>


                        {/* Footer de A√ß√µes */}
                        <div className="mt-8 pt-4 border-t border-gray-200 flex justify-end items-center gap-3">
                            <button 
                                onClick={onClose}
                                className="px-6 py-3 rounded-full font-medium text-gray-600 transition border border-gray-300 hover:bg-gray-100"
                            >
                                Cancelar
                            </button>
                            <button
                                onClick={() => onConfirmImport(stagedData, targetListId)}
                                disabled={totalValid === 0 || !targetListId}
                                className={`px-6 py-3 rounded-full font-bold text-white transition shadow-lg flex items-center gap-2 ${totalValid === 0 ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}
                            >
                                <Icon name="database" size={18}/> Importar {totalValid} Contatos V√°lidos
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        // --- App Principal ---
        const App = () => {
            const { ResponsiveContainer, AreaChart, Area, CartesianGrid, XAxis, YAxis, Tooltip } = window.Recharts || {}; 
            
            // FIREBASE/AUTH/DB REFERENCES
            const db = window.db;
            const auth = window.auth;
            const appId = window.appId;
            const onAuthStateChanged = window.onAuthStateChanged; // Acessando a fun√ß√£o global
            const onSnapshot = window.onSnapshot; // Acessando a fun√ß√£o global
            const collection = window.collection; // Acessando a fun√ß√£o global
            const doc = window.doc; // Acessando a fun√ß√£o global
            const writeBatch = window.writeBatch; // Acessando a fun√ß√£o global
            
            // --- ESTADOS GLOBAIS ---
            const [activeTab, setActiveTab] = useState('dashboard');
            const [contacts, setContacts] = useState([]); // Agora carregado do Firestore
            const [contactLists, setContactLists] = useState([]); // Agora carregado do Firestore
            const [isAuthReady, setIsAuthReady] = useState(false); // NOVO: Flag para aguardar Auth
            
            const [isConnected, setIsConnected] = useState(false);
            const [connectionStep, setConnectionStep] = useState(0); 
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalContent, setModalContent] = useState({ title: '', message: '' });
            const [selectedContactDetail, setSelectedContactDetail] = useState(null);
            const [selectedListToManage, setSelectedListToManage] = useState(null); 
            const [isCreateListModalOpen, setIsCreateListModalOpen] = useState(false); // NOVO: Estado para abrir modal de cria√ß√£o
            
            // Estados para o fluxo de importa√ß√£o
            const [stagedContacts, setStagedContacts] = useState([]);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false);
            const [isBulkPasteModalOpen, setIsBulkPasteModalOpen] = useState(false); 

            // Estado do Disparo - Reworked for Flow
            const [campaignStep, setCampaignStep] = useState(1); 
            const [messageText, setMessageText] = useState("Ol√° {nome}, temos uma oferta especial para voc√™ hoje!");
            const [salutationVar, setSalutationVar] = useState("{nome}"); 
            const [mediaAttached, setMediaAttached] = useState(false); 
            const [selectedListId, setSelectedListId] = useState(null); 
            const [isSending, setIsSending] = useState(false);
            const [sendingProgress, setSendingProgress] = useState({ total: 0, sent: 0, failed: 0, logs: [] });
            
            // NOVOS ESTADOS PARA CONTROLE DE SA√öDE
            const [dailyLimit, setDailyLimit] = useState(1500); 
            const [todaySent, setTodaySent] = useState(350); 
            const [isBlocked, setIsBlocked] = useState(false); 
            const [isSuspended, setIsSuspended] = useState(false); 

            // Estado de Chat (Espelhamento) - Mock inicial e mensagens
            const initialChats = [
                { id: 1, name: 'Jo√£o Silva', lastMsg: 'Obrigado!', time: '10:30', unread: 2, number: '5511999998888' },
                { id: 2, name: 'Suporte Clientes', lastMsg: 'Ok, verificado.', time: '09:15', unread: 0, number: '5521988887777' },
            ];
            const [chats, setChats] = useState(initialChats);
            const [selectedChat, setSelectedChat] = useState(null);
            const [currentChatMessages, setCurrentChatMessages] = useState([]); // NOVO: Mensagens do chat selecionado
            const [messageInput, setMessageInput] = useState(''); // NOVO: Input para resposta
            
            // 1. EFEITO DE AUTENTICA√á√ÉO E SETUP INICIAL
            useEffect(() => {
                if (window.authenticate && auth && onAuthStateChanged) {
                    window.authenticate().then(() => {
                        // Listener para garantir que o UID esteja pronto
                        onAuthStateChanged(auth, (user) => {
                            if (user) {
                                setIsAuthReady(true);
                                console.log("User UID ready:", user.uid);
                            } else {
                                // Caso n√£o consiga autenticar, ainda permite carregar, mas sem salvar no user-specific
                                setIsAuthReady(true);
                                console.log("Anonymous User Ready.");
                            }
                        });
                    }).catch(error => {
                        console.error("Authentication setup failed:", error);
                        setIsAuthReady(true); // Permite o UI carregar mesmo com falha de auth
                    });
                }
            }, []);

            // 2. EFEITO DE CARREGAMENTO DE DADOS DO FIRESTORE (Ap√≥s Auth)
            useEffect(() => {
                // √â CRUCIAL ter o UID para acessar os dados privados (Permission Denied √© a falha)
                const userId = auth?.currentUser?.uid; 
                
                if (!isAuthReady || !userId || !db || !onSnapshot) return;

                // Listener 1: Contatos
                const contactsRef = collection(db, `artifacts/${appId}/users/${userId}/contacts`);
                const unsubscribeContacts = onSnapshot(contactsRef, (snapshot) => {
                    const loadedContacts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setContacts(loadedContacts);
                    console.log("Contatos carregados:", loadedContacts.length);
                }, (error) => {
                    // Loga o erro de permiss√£o para indicar ao usu√°rio o problema na regra
                    console.error("Firestore Contacts Listener Error:", error);
                    // N√£o faz return para n√£o quebrar o app totalmente, mas o usu√°rio n√£o ver√° dados
                });

                // Listener 2: Listas de Contato
                const listsRef = collection(db, `artifacts/${appId}/users/${userId}/contactLists`);
                const unsubscribeLists = onSnapshot(listsRef, (snapshot) => {
                    const loadedLists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setContactLists(loadedLists);
                    if (loadedLists.length > 0 && selectedListId === null) {
                        setSelectedListId(loadedLists[0].id); // Seleciona a primeira lista como padr√£o
                    }
                    console.log("Listas carregadas:", loadedLists.length);
                }, (error) => {
                    console.error("Firestore Lists Listener Error:", error);
                });

                // Cleanup listeners
                return () => {
                    unsubscribeContacts();
                    unsubscribeLists();
                };
            }, [isAuthReady, db, auth?.currentUser?.uid]);


            // Efeito para re-renderizar √≠cones
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [activeTab]); 

            // L√≥gica de Mensagens no Inbox
            const handleSendMessage = () => {
                if (!messageInput.trim()) return;

                const newMessage = {
                    id: Date.now(),
                    text: messageInput,
                    sender: 'Eu',
                    time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                    status: 'sent'
                };
                
                // Simula√ß√£o: Envia a mensagem para a API
                console.log(`Mensagem enviada para ${selectedChat.name}: ${messageInput}`);

                // Atualiza o hist√≥rico local do chat (Simula√ß√£o bidirecional)
                setCurrentChatMessages(prev => [...prev, newMessage]);
                
                // Simula√ß√£o de resposta (para fins de prot√≥tipo)
                setTimeout(() => {
                    setCurrentChatMessages(prev => [...prev, {
                        id: Date.now() + 1,
                        text: `Obrigado por sua mensagem, ${selectedChat.name.split(' ')[0]}. Resposta autom√°tica simulada.`,
                        sender: selectedChat.name,
                        time: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }),
                        status: 'received'
                    }]);
                }, 1500);

                setMessageInput('');
            };


            // Fun√ß√£o para mostrar Modal
            const showModal = (title, message) => {
                setModalContent({ title, message });
                setIsModalOpen(true);
            };
            const openContactDetail = (contact) => {
                setSelectedContactDetail(contact);
            };
            const openListManagementModal = (list) => {
                setSelectedListToManage(list);
            };
            
            // NOVO: L√≥gica de cria√ß√£o de Lista
            const handleCreateNewList = async (listName) => {
                if (!isAuthReady || !auth?.currentUser?.uid || !db || !window.setDoc) {
                    showModal("Erro", "O sistema de autentica√ß√£o n√£o est√° pronto.");
                    return;
                }
                if (listName.trim() === "") {
                    showModal("Erro", "O nome da lista n√£o pode ser vazio.");
                    return;
                }

                const userId = auth.currentUser.uid;
                const newId = `list-${Date.now()}`;
                const listRef = doc(db, `artifacts/${appId}/users/${userId}/contactLists`, newId);

                try {
                    await window.setDoc(listRef, { 
                        id: newId,
                        name: listName, 
                        contactIds: [],
                        createdAt: new Date().toISOString()
                    });
                    showModal("Sucesso", `Lista "${listName}" criada e salva no Firestore!`);
                    setIsCreateListModalOpen(false);
                } catch (e) {
                    console.error("Erro ao criar lista:", e);
                    showModal("Erro de Persist√™ncia", "Falha ao criar lista. Verifique as permiss√µes.");
                }
            };
            
            // Valida√ß√£o simulada
            const isPhoneNumberValid = (number) => {
                const cleaned = number ? number.toString().replace(/\D/g, '') : '';
                return cleaned.length >= 10 && cleaned.length <= 13 && cleaned.startsWith('55');
            };

            // L√ìGICA DE NEG√ìCIO SIMULADA
            const getContactsByList = (listId) => { 
                if (!listId || contactLists.length === 0 || contacts.length === 0) return [];
                const list = contactLists.find(l => l.id === listId);
                if (!list) return [];
                return contacts.filter(c => list.contactIds.includes(c.id)); 
            };
            const getUniqueContactCount = () => { 
                 if (contactLists.length === 0 || contacts.length === 0) return 0;
                 return new Set(contactLists.flatMap(l => l.contactIds).filter(id => contacts.some(c => c.id === id))).size;
            };
            
            // Fun√ß√£o para download do template CSV
            const downloadTemplate = () => {
                const csvContent = "data:text/csv;charset=utf-8,Nome,Numero,Variavel1\nJo√£o da Silva,5511987654321,Campanha A\nMaria Souza,5521912345678,Campanha B";
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "modelo_importacao_zapflow.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            
            // L√≥gica de importa√ß√£o - Reworked para Preview
            const handleFileUpload = (e) => {
                 const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    const text = evt.target.result;
                    const lines = text.split('\n');
                    const staged = [];

                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;

                        const cols = line.split(',');
                        if (cols.length >= 2) {
                            const newContact = {
                                name: (cols[0] || '').trim(),
                                number: (cols[1] || '').trim(),
                                variable1: (cols[2] || '').trim(),
                                isValid: false,
                            };
                            newContact.isValid = isPhoneNumberValid(newContact.number) && newContact.name.length > 0;
                            staged.push(newContact);
                        }
                    }
                    
                    if (staged.length > 0) {
                        setStagedContacts(staged);
                        setIsImportModalOpen(true);
                    } else {
                        showModal("Erro de Leitura", "O arquivo CSV n√£o cont√©m dados v√°lidos ou est√° vazio ap√≥s o cabe√ßalho.");
                    }
                };
                reader.readAsText(file);
                e.target.value = null; 
            };

            // L√≥gica de Confirma√ß√£o Final de Importa√ß√£o - AGORA USA FIRESTORE BATCH
            const handleConfirmImport = async (validatedData, targetListId) => {
                if (!isAuthReady || !auth?.currentUser?.uid || !db || !writeBatch) {
                     showModal("Erro de Autentica√ß√£o", "O sistema de persist√™ncia n√£o est√° pronto. Tente recarregar.");
                     return;
                }

                const userId = auth.currentUser.uid;
                const batch = writeBatch(db);
                const newContactIds = [];
                let validCount = 0;

                validatedData.forEach(staged => {
                    const finalIsValid = isPhoneNumberValid(staged.number) && staged.name.length > 0;

                    if (finalIsValid) {
                        const newId = `contact-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
                        const contactRef = doc(db, `artifacts/${appId}/users/${userId}/contacts`, newId);
                        
                        batch.set(contactRef, {
                            id: newId, // Garante que o ID do documento seja salvo no objeto
                            name: staged.name,
                            number: staged.number,
                            status: 'Ativo',
                            sentWeek: 0, sentMonth: 0, sentYear: 0, blockedCount: 0,
                            lastSent: new Date().toISOString(), lastSentViewed: false, lastSentReplied: false,
                            variable1: staged.variable1 || 'N/A'
                        });
                        newContactIds.push(newId);
                        validCount++;
                    }
                });

                if (validCount > 0 && targetListId) {
                    // targetListId √© uma string ou null. Precisamos ter certeza que √© string para o doc.
                    const listIdStr = targetListId.toString(); 
                    const listRef = doc(db, `artifacts/${appId}/users/${userId}/contactLists`, listIdStr);
                    const currentList = contactLists.find(l => l.id == targetListId); // Usando == para comparar number com string
                    
                    if (currentList) {
                        const updatedContactIds = [...new Set([...currentList.contactIds, ...newContactIds])];
                         batch.update(listRef, { contactIds: updatedContactIds });
                    } else {
                        batch.set(listRef, { id: listIdStr, name: "Lista Importada (Fallback)", contactIds: newContactIds });
                    }

                    try {
                        await batch.commit();
                        showModal("Importa√ß√£o Conclu√≠da", `${validCount} contatos v√°lidos foram adicionados √† Base Mestra e √† lista.`);
                    } catch (e) {
                        console.error("Erro ao commitar batch:", e);
                        showModal("Erro de Persist√™ncia", "Falha ao salvar dados no Firestore. Verifique o console.");
                    }

                } else if (validCount > 0) {
                    showModal("Importa√ß√£o Parcial", "Contatos validados, mas nenhuma lista selecionada para vincular.");
                } else {
                    showModal("Nenhum Contato Importado", "Nenhum contato v√°lido foi encontrado para importa√ß√£o.");
                }

                setIsImportModalOpen(false);
                setIsBulkPasteModalOpen(false);
                setStagedContacts([]);
            };
            
            const startCampaign = async () => { /* Mantida */ };
            
            // L√ìGICA DE C√ÅLCULO DE SA√öDE APRIMORADA
            const calculateHealth = () => { 
                if (isBlocked || isSuspended) return 0;

                const totalSent = contacts.reduce((acc, c) => acc + (c.sentYear || 0), 0);
                const totalBlocks = contacts.reduce((acc, c) => acc + (c.blockedCount || 0), 0);
                
                let score = 100;
                
                // Penalidade por volume alto (Aquecimento)
                if (todaySent > dailyLimit * 0.9) score -= 15; // Quase atingindo o limite
                if (todaySent > dailyLimit * 1.05) score -= 30; // Excedeu o limite

                // Penalidade por bloqueios
                if (totalBlocks > 0) score -= (totalBlocks * 10);
                
                return Math.max(0, score);
            };
            const healthScore = calculateHealth();

            // Detalhes do Cart√£o
            const openMetricDetail = (metricType) => { 
                let title = "";
                let content = null;
                const totalSent = contacts.reduce((acc, c) => acc + (c.sentYear || 0), 0);
                const totalBlocked = contacts.reduce((acc, c) => acc + (c.blockedCount || 0), 0);
                const totalReplied = contacts.filter(c => c.lastSentReplied).length;

                switch(metricType) {
                    case 'contacts':
                        title = "Detalhes dos Contatos √önicos";
                        content = (
                            <div className="space-y-3">
                                <p><strong>Total na Base Mestra:</strong> <span className="text-xl font-bold text-blue-600">{contacts.length}</span></p>
                                <p><strong>Contatos √önicos:</strong> <span className="text-xl font-bold text-blue-600">{getUniqueContactCount()}</span></p>
                                <p className="text-xs text-gray-500">Isso representa o n√∫mero de telefones n√£o duplicados cadastrados em todas as listas.</p>
                                <div className="p-2 bg-gray-100 rounded-lg text-xs">
                                    <p>Listas ativas: {contactLists.length}</p>
                                    <p>O n√∫mero de contatos √∫nicos deve crescer de forma org√¢nica.</p>
                                </div>
                            </div>
                        );
                        break;
                    case 'sends':
                        title = "Performance de Disparos";
                        content = (
                             <div className="space-y-3">
                                <p><strong>Disparos na Semana:</strong> <span className="text-xl font-bold text-emerald-600">{contacts.reduce((acc, c) => acc + (c.sentWeek || 0), 0)}</span></p>
                                <p><strong>Total Geral (Ano):</strong> <span className="text-xl font-bold text-emerald-600">{totalSent}</span></p>
                                <p className="text-xs text-gray-500">M√©dia di√°ria: {Math.round(contacts.reduce((acc, c) => acc + (c.sentWeek || 0), 0) / 7)} envios.</p>
                                <p className="mt-2 text-sm font-semibold">Dica: Mantenha o volume consistente para aquecer o n√∫mero.</p>
                            </div>
                        );
                        break;
                    case 'health':
                        title = "Sa√∫de e Aquecimento do N√∫mero";
                        content = (
                            <div className="space-y-3">
                                {isBlocked && <div className="p-2 bg-red-100 text-red-800 font-bold rounded-lg"><Icon name="lock" size={16} className="inline-block mr-1"/> BLOQUEIO CR√çTICO! A√ß√µes suspensas.</div>}
                                {isSuspended && <div className="p-2 bg-orange-100 text-orange-800 font-bold rounded-lg"><Icon name="alert-triangle" size={16} className="inline-block mr-1"/> SUSPENS√ÉO TEMPOR√ÅRIA!</div>}

                                <p><strong>Score Atual:</strong> <span className={`text-xl font-bold ${healthScore > 80 ? 'text-green-600' : 'text-red-600'}`}>{healthScore}%</span></p>
                                
                                <div className="border-t pt-2 mt-2">
                                    <p className="text-sm font-medium">Uso Di√°rio (Aquecimento):</p>
                                    <p>Enviados Hoje: <span className="font-bold">{todaySent}</span> / {dailyLimit} mensagens</p>
                                    <p className="text-xs text-gray-500">
                                        Status: {todaySent < dailyLimit * 0.8 ? 'Seguro' : 'Alto Volume'}
                                    </p>
                                </div>

                                <p className="text-xs text-gray-500">Bloqueios Reportados: {totalBlocked}</p>
                            </div>
                        );
                        break;
                    case 'response':
                        title = "An√°lise de Retorno (Respostas)";
                        content = (
                            <div className="space-y-3">
                                <p><strong>Taxa de Resposta:</strong> <span className="text-xl font-bold text-purple-600">4.2%</span></p>
                                <p><strong>Contatos que Responderam:</strong> <span className="text-xl font-bold text-purple-600">{totalReplied}</span></p>
                                <p className="text-xs text-gray-500">Esta taxa indica a efetividade da sua mensagem.</p>
                                <p className="mt-2 text-sm font-semibold">Estrat√©gia: Use personaliza√ß√£o e CTAs claros para aumentar a taxa.</p>
                            </div>
                        );
                        break;
                    default:
                        title = "M√©trica Desconhecida";
                        content = "Nenhuma informa√ß√£o detalhada dispon√≠vel.";
                }

                showModal(title, content);
            };

            // NOVO: Componente para o Alerta de Sa√∫de no Header
            const HealthWarningBanner = () => {
                if (!isConnected || (!isBlocked && !isSuspended)) return null;

                const message = isBlocked 
                    ? "‚ö†Ô∏è BLOQUEIO CR√çTICO! A√ß√µes de envio SUSPENSAS. Verifique a Conex√£o."
                    : isSuspended
                    ? "‚ö†Ô∏è SUSPENS√ÉO TEMPOR√ÅRIA DETECTADA. Reduza o volume."
                    : null;
                
                if (!message) return null;

                const bgColor = isBlocked ? 'bg-red-600' : 'bg-orange-500';
                
                return (
                    <div className={`${bgColor} text-white text-xs font-bold p-2 text-center flex items-center justify-center gap-2`}
                         onClick={() => setActiveTab('connect')}
                         title="Clique para ver detalhes"
                    >
                        <Icon name="zap-off" size={16}/>
                        {message}
                    </div>
                );
            };

            // Componente Modal de Cria√ß√£o de Lista
            const CreateListModal = ({ isOpen, onClose, onCreate }) => {
                const [newListName, setNewListName] = useState('');

                if (!isOpen) return null;

                const handleCreate = () => {
                    onCreate(newListName);
                    setNewListName('');
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm transform transition-all">
                            <h3 className="text-xl font-bold mb-4 text-gray-800 flex items-center gap-2">
                                <Icon name="list-plus" size={24} className="text-blue-600"/> Criar Nova Lista
                            </h3>
                            
                            <label className="block text-sm font-medium text-gray-700 mb-1">Nome da Nova Lista</label>
                            <input
                                type="text"
                                value={newListName}
                                onChange={(e) => setNewListName(e.target.value)}
                                onKeyPress={(e) => { if (e.key === 'Enter') handleCreate(); }}
                                placeholder="Ex: Clientes VIP, Leads Frios"
                                className="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none mb-6"
                            />

                            <div className="flex justify-between gap-3">
                                <button
                                    onClick={onClose}
                                    className="px-4 py-2 rounded-full font-medium text-gray-600 transition border border-gray-300 hover:bg-gray-100 flex-1"
                                >
                                    Cancelar
                                </button>
                                <button
                                    onClick={handleCreate}
                                    disabled={newListName.trim().length === 0}
                                    className={`px-4 py-2 rounded-full font-bold text-white transition shadow-lg flex-1 ${newListName.trim().length === 0 ? 'bg-gray-400' : 'bg-blue-600 hover:bg-blue-700'}`}
                                >
                                    Criar Lista
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };


            // --- COMPONENTES DE TELA - REWORKED ---

            // 1. DASHBOARD (Visualmente mais limpo)
            const Dashboard = () => { 
                return (
                    <div className="space-y-8 animate-fade-in">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                            
                            {/* Cart√£o 1: Contatos √önicos */}
                            <button 
                                onClick={() => openMetricDetail('contacts')} 
                                className="bg-white p-6 rounded-2xl shadow-xl border border-gray-100 transition-all hover:ring-2 hover:ring-blue-300 hover:shadow-2xl text-left"
                            >
                                <Icon name="users" size={28} className="text-blue-500 mb-3"/>
                                <p className="text-gray-500 text-sm">Contatos √önicos</p>
                                <h3 className="text-4xl font-extrabold text-gray-900">{getUniqueContactCount()}</h3>
                            </button>
                            
                            {/* Cart√£o 2: Disparos */}
                            <button 
                                onClick={() => openMetricDetail('sends')}
                                className="bg-white p-6 rounded-2xl shadow-xl border border-gray-100 transition-all hover:ring-2 hover:ring-emerald-300 hover:shadow-2xl text-left"
                            >
                                <Icon name="send" size={28} className="text-emerald-500 mb-3"/>
                                <p className="text-gray-500 text-sm">Disparos (Base)</p>
                                <h3 className="text-4xl font-extrabold text-gray-900">{contacts.reduce((acc, c) => acc + (c.sentYear || 0), 0)}</h3>
                            </button>
                            
                            {/* Cart√£o 3: Sa√∫de do N√∫mero */}
                            <button 
                                onClick={() => openMetricDetail('health')}
                                className={`bg-white p-6 rounded-2xl shadow-xl border border-gray-100 transition-all hover:ring-2 hover:shadow-2xl text-left ${healthScore > 80 ? 'hover:ring-green-300' : 'hover:ring-red-300'}`}
                            >
                                <Icon name="activity" size={28} className={healthScore > 80 ? 'text-green-600 mb-3' : 'text-red-600 mb-3'}/>
                                <p className="text-gray-500 text-sm">Sa√∫de do N√∫mero</p>
                                <h3 className={`text-4xl font-extrabold ${healthScore > 80 ? 'text-green-700' : 'text-red-700'}`}>{healthScore}%</h3>
                            </button>
                            
                            {/* Cart√£o 4: Retornos */}
                            <button 
                                onClick={() => openMetricDetail('response')}
                                className="bg-white p-6 rounded-2xl shadow-xl border border-gray-100 transition-all hover:ring-2 hover:ring-purple-300 hover:shadow-2xl text-left"
                            >
                                <Icon name="message-square-text" size={28} className="text-purple-500 mb-3"/>
                                <p className="text-gray-500 text-sm">Taxa de Resposta</p>
                                <h3 className="text-4xl font-extrabold text-gray-900">4.2%</h3>
                            </button>
                        </div>

                        {/* Gr√°fico de Tend√™ncias */}
                        <div className="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
                            <h4 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><Icon name="trending-up" size={20}/> Tend√™ncia Semanal de Envio</h4>
                            <div className="h-80 w-full">
                                {ResponsiveContainer && AreaChart ? (
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={[
                                            {name: 'Seg', envios: 400}, {name: 'Ter', envios: 300}, {name: 'Qua', envios: 600},
                                            {name: 'Qui', envios: 800}, {name: 'Sex', envios: 500}, {name: 'Sab', envios: 100}, {name: 'Dom', envios: 200}
                                        ]}>
                                            <defs>
                                                <linearGradient id="colorEnviosV2" x1="0" y1="0" x2="0" y2="1">
                                                    <stop offset="5%" stopColor="#059669" stopOpacity={0.8}/>
                                                    <stop offset="95%" stopColor="#059669" stopOpacity={0}/>
                                                </linearGradient>
                                            </defs>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
                                            <XAxis dataKey="name" stroke="#6b7280"/>
                                            <YAxis stroke="#6b7280"/>
                                            <Tooltip contentStyle={{ borderRadius: '12px', border: '1px solid #e5e7eb', boxShadow: '0 6px 12px rgba(0,0,0,0.1)' }}/>
                                            <Area type="monotone" dataKey="envios" stroke="#059669" fillOpacity={1} fill="url(#colorEnviosV2)" strokeWidth={3}/>
                                        </AreaChart>
                                    </ResponsiveContainer>
                                ) : (
                                    <div className="flex items-center justify-center h-full text-gray-400">Carregando dados do gr√°fico...</div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            // 2. CONEX√ÉO WHATSAPP (Mantida a l√≥gica, novo visual)
            const Connection = () => { /* C√≥digo da Conex√£o Mantido */ return (
                <div className="flex flex-col items-center justify-center h-full bg-white rounded-2xl shadow-xl p-10 animate-fade-in">
                    <h2 className="text-3xl font-extrabold mb-8 text-gray-900">Gerenciar Conex√£o API</h2>
                    
                    {connectionStep === 0 && (
                        <div className="text-center">
                            <div className="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6 text-gray-400">
                                <Icon name="smartphone" size={48} />
                            </div>
                            <h3 className="text-xl font-bold mb-3">Conectar N√∫mero</h3>
                            <p className="text-gray-500 mb-8 max-w-md">
                                Conecte seu n√∫mero para iniciar as automa√ß√µes.
                            </p>
                            <button 
                                onClick={() => setConnectionStep(1)}
                                className="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-full font-medium transition flex items-center mx-auto gap-2 shadow-lg hover:shadow-xl transform hover:scale-[1.02]"
                            >
                                <Icon name="qr-code" size={18} /> Gerar Novo QR Code
                            </button>
                        </div>
                    )}

                    {connectionStep === 1 && (
                        <div className="text-center animate-fade-in">
                            <h3 className="font-bold text-xl mb-4 text-gray-800">Escaneie o c√≥digo abaixo</h3>
                            <p className="text-sm text-gray-600 mb-6">Abra o WhatsApp, v√° em Configura√ß√µes > Dispositivos Conectados.</p>
                            <div className="bg-white p-6 border-4 border-emerald-500 rounded-xl inline-block mb-4 relative shadow-2xl">
                                {/* Simula√ß√£o de QR Code */}
                                <div className="w-72 h-72 bg-gray-900 flex items-center justify-center text-white p-4">
                                    <Icon name="scan" size={48} className="text-emerald-500"/>
                                    <span className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xs font-bold bg-gray-900 px-2 py-1 rounded">QR CODE SIMULADO</span>
                                </div>
                                <div className="absolute inset-0 flex items-center justify-center bg-white/80 animate-pulse" style={{animationDuration: '2s', opacity: 0.9}}>
                                    <span className="text-sm font-bold text-gray-800">Aguardando leitura...</span>
                                </div>
                            </div>
                            {/* Bot√£o de Simula√ß√£o Aprimorado */}
                            <div className="mt-6 p-4 bg-gray-100 rounded-xl">
                                <button 
                                    onClick={() => {
                                        setConnectionStep(2);
                                        setIsConnected(true);
                                    }}
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-full font-bold transition shadow-md"
                                >
                                    Simular Leitura Conclu√≠da (Avan√ßar)
                                </button>
                                <p className="text-xs text-gray-500 mt-2">Clique para simular o escaneamento do QR Code e conectar a API.</p>
                            </div>
                        </div>
                    )}

                    {connectionStep === 2 && (
                        <div className="text-center animate-fade-in">
                            <div className="w-24 h-24 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6 text-emerald-600">
                                <Icon name="check-circle" size={48} />
                            </div>
                            <h3 className="text-2xl font-bold mb-3 text-emerald-800">Conectado e Operacional!</h3>
                            <p className="text-gray-500 mb-8">
                                <span className="font-bold">N√∫mero Conectado:</span> +55 (11) 99999-9999<br/>
                                <span className="font-bold">Status da API:</span> <span className="text-green-500 font-bold">Online</span>
                            </p>
                            
                            {/* NOVO: CONTROLES DE SA√öDE SIMULADOS */}
                            <div className="mt-6 p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                                <p className="font-bold text-yellow-800 mb-2">Controle de Sa√∫de do N√∫mero:</p>
                                <div className="flex justify-center gap-4">
                                    <button 
                                        onClick={() => setIsBlocked(prev => !prev)}
                                        className={`px-4 py-1 text-sm rounded-full font-medium transition ${isBlocked ? 'bg-red-500 text-white' : 'bg-red-200 text-red-700 hover:bg-red-300'}`}
                                    >
                                        {isBlocked ? '‚úÖ Bloqueado' : 'Simular Bloqueio'}
                                    </button>
                                    <button 
                                        onClick={() => setIsSuspended(prev => !prev)}
                                        className={`px-4 py-1 text-sm rounded-full font-medium transition ${isSuspended ? 'bg-orange-500 text-white' : 'bg-orange-200 text-orange-700 hover:bg-orange-300'}`}
                                    >
                                        {isSuspended ? '‚úÖ Suspenso' : 'Simular Suspens√£o'}
                                    </button>
                                </div>
                            </div>

                            <button 
                                onClick={() => {
                                    setConnectionStep(0);
                                    setIsConnected(false);
                                }}
                                className="text-red-500 text-sm hover:text-red-700 font-medium transition flex items-center mx-auto gap-1 mt-6"
                            >
                                <Icon name="power" size={16}/> Desconectar Dispositivo (Mant√©m Hist√≥rico)
                            </button>
                        </div>
                    )}
                </div>
            ); };

            // 3. CAMPANHA E DISPARO (REWORKED - FLUXO DE 3 ETAPAS)
            const Campaign = () => { /* C√≥digo da Campanha Mantido */ 
                const targetContacts = getContactsByList(selectedListId);
                const currentListName = contactLists.find(l => l.id == selectedListId)?.name || 'Lista N√£o Selecionada';
                const totalContactsInList = targetContacts.length;

                const getPreviewText = () => {
                    const baseText = messageText.replace(/\{nome\}/gi, 'Cliente Exemplo').replace(/\{numero\}/gi, '99999-9999');
                    const finalMsg = baseText.replace(salutationVar, 'Cliente Exemplo');
                    return finalMsg;
                };

                const progressItems = [
                    { step: 1, label: 'Selecionar Lista', icon: 'list-checks' },
                    { step: 2, label: 'Criar Mensagem', icon: 'message-square-plus' },
                    { step: 3, label: 'Revisar & Enviar', icon: 'send' },
                ];

                const StepIndicator = () => (
                    <div className="flex justify-between items-center mb-10 w-full max-w-4xl mx-auto">
                        {progressItems.map(item => (
                            <div key={item.step} className="flex flex-col items-center flex-1 relative">
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white transition-all duration-300 shadow-md ${
                                    campaignStep === item.step ? 'bg-blue-600 ring-4 ring-blue-200' : 
                                    campaignStep > item.step ? 'bg-emerald-600' : 
                                    'bg-gray-300 text-gray-600'
                                }`}>
                                    <Icon name={item.icon} size={18} />
                                </div>
                                <span className={`mt-2 text-xs font-medium text-center hidden sm:block ${campaignStep >= item.step ? 'text-gray-800' : 'text-gray-500'}`}>{item.label}</span>
                                {item.step < 3 && (
                                    <div className={`absolute left-[50%] top-5 h-0.5 w-[calc(100%+80px)] transition-colors duration-300 transform -translate-x-[calc(50%+20px)] ${campaignStep > item.step ? 'bg-emerald-500' : 'bg-gray-200'}`}></div>
                                )}
                            </div>
                        ))}
                    </div>
                );
                
                // STEP 1: Selecionar Lista
                const Step1 = () => (
                    <div className="bg-white p-8 rounded-2xl shadow-xl border border-gray-100 max-w-xl mx-auto animate-fade-in">
                        <h3 className="text-2xl font-bold text-gray-800 mb-6">1. Selecionar Lista de Contatos</h3>
                        
                        <label className="block text-sm font-medium text-gray-700 mb-2">Lista de Disparo</label>
                        <select
                            value={selectedListId || ''}
                            onChange={(e) => setSelectedListId(e.target.value)}
                            className="w-full border border-gray-300 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none text-base bg-white shadow-sm"
                        >
                            {contactLists.map(list => (
                                <option key={list.id} value={list.id}>
                                    {list.name} ({list.contactIds.length} contatos)
                                </option>
                            ))}
                        </select>
                        
                        <div className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-xl text-sm">
                            <p className="font-bold text-blue-700">Contatos na Lista:</p>
                            <p className="text-blue-600 text-xl font-extrabold">{totalContactsInList}</p>
                            <p className="text-xs text-gray-600 mt-2">Certifique-se de que a lista est√° higienizada (Verifique na aba Contatos).</p>
                        </div>

                        <button
                            onClick={() => {
                                if (totalContactsInList === 0) return showModal("Aten√ß√£o", "A lista selecionada n√£o tem contatos.");
                                setCampaignStep(2);
                            }}
                            className="w-full mt-8 py-3 rounded-full font-bold text-white flex items-center justify-center gap-2 transition bg-blue-600 hover:bg-blue-700 shadow-lg"
                        >
                            <Icon name="arrow-right" size={18}/> Pr√≥xima Etapa: Criar Mensagem
                        </button>
                    </div>
                );
                
                // STEP 2: Criar Mensagem
                const Step2 = () => (
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-fade-in">
                        <div className="bg-white p-8 rounded-2xl shadow-xl border border-gray-100 flex flex-col">
                            <h3 className="text-2xl font-bold text-gray-800 mb-6">2. Criar Conte√∫do da Campanha</h3>
                            
                            {/* TEXTAREA */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Texto Principal</label>
                                <div className="relative">
                                    <textarea 
                                        className="w-full border border-gray-300 rounded-xl p-4 h-48 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none resize-none text-sm shadow-inner"
                                        value={messageText}
                                        onChange={(e) => setMessageText(e.target.value)}
                                        placeholder="Digite sua mensagem. Use {nome} para personalizar."
                                    ></textarea>
                                    <div className="absolute bottom-3 right-3 flex gap-2">
                                        <button 
                                            className="px-2 py-1 text-xs bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-full font-bold transition" 
                                            title="Adicionar Vari√°vel Nome" 
                                            onClick={() => setMessageText(prev => prev + ' {nome}')}>
                                            {`{nome}`}
                                        </button>
                                        <button 
                                            className={`p-1.5 rounded-full transition shadow-md ${mediaAttached ? 'bg-emerald-100 text-emerald-600' : 'text-gray-500 hover:bg-gray-100'}`}
                                            title="Anexar M√≠dia"
                                            onClick={() => setMediaAttached(!mediaAttached)}
                                        >
                                            <Icon name={mediaAttached ? "check-circle" : "paperclip"} size={16}/>
                                        </button>
                                    </div>
                                </div>
                                <p className="text-xs text-gray-500 mt-2 flex items-center gap-1">
                                    <Icon name="tag" size={14} className="text-blue-500"/> Personaliza√ß√£o ativa: {mediaAttached ? 'M√≠dia Anexada' : 'Sem M√≠dia'}
                                </p>
                            </div>
                            
                            <div className="flex justify-between gap-4 mt-8">
                                <button
                                    onClick={() => setCampaignStep(1)}
                                    className="px-6 py-3 rounded-full font-medium text-gray-600 flex items-center justify-center gap-2 transition border border-gray-300 hover:bg-gray-100"
                                >
                                    <Icon name="arrow-left" size={18}/> Voltar
                                </button>
                                <button
                                    onClick={() => setCampaignStep(3)}
                                    className="px-6 py-3 rounded-full font-bold text-white flex items-center justify-center gap-2 transition bg-blue-600 hover:bg-blue-700 shadow-lg flex-1"
                                >
                                    Pr√≥xima Etapa: Revis√£o <Icon name="arrow-right" size={18}/>
                                </button>
                            </div>
                        </div>

                        {/* Preview (Celular) - Lado a Lado */}
                        <div className="flex justify-center items-start lg:items-center">
                            <div className="iphone-preview w-[320px] h-[650px] flex flex-col">
                                
                                {/* Header WhatsApp */}
                                <div className="bg-[#075e54] text-white p-3 flex items-center gap-2 z-10 shadow-md">
                                    <div className="w-8 h-8 bg-gray-300 rounded-full overflow-hidden">
                                        <img src="https://i.pravatar.cc/100?u=previewuser" alt="Avatar" className="w-full h-full object-cover"/>
                                    </div>
                                    <p className="font-bold text-sm flex-1">Cliente Exemplo</p>
                                    <Icon name="more-vertical" size={18} className="text-emerald-100"/>
                                </div>

                                {/* Chat Area */}
                                <div className="chat-bg flex-1 p-3 overflow-y-auto flex flex-col gap-2">
                                    {/* Preview de Anexo (simulado) */}
                                    {mediaAttached && (
                                        <div className="bg-[#d9fdd3] self-end p-2 rounded-lg rounded-tr-none shadow max-w-[80%] text-sm break-words border border-emerald-300">
                                            <div className="bg-emerald-100 h-24 w-full rounded-lg flex items-center justify-center mb-2">
                                                <Icon name="image" size={32} className="text-emerald-600"/>
                                            </div>
                                            <p className="font-semibold text-xs text-gray-700">anexo-campanha-promocional.jpg</p>
                                        </div>
                                    )}

                                    {/* A mensagem preview */}
                                    <div className="bg-[#d9fdd3] self-end px-3 py-2 rounded-lg rounded-tr-none shadow max-w-[80%] text-sm break-words">
                                        {getPreviewText()}
                                        <span className="block text-[10px] text-gray-500 text-right mt-1 flex justify-end items-center gap-1">
                                            agora <Icon name="check-check" size={12} className="text-blue-500"/>
                                        </span>
                                    </div>
                                </div>

                                 {/* Footer Input */}
                                 <div className="bg-[#f0f2f5] p-2 flex items-center gap-2 border-t border-gray-200">
                                    <Icon name="plus" size={20} className="text-gray-500"/>
                                    <div className="bg-white flex-1 rounded-full px-3 py-1.5 text-sm text-gray-600 border border-gray-300">
                                        Digite uma mensagem
                                    </div>
                                    <div className="bg-emerald-600 w-8 h-8 rounded-full flex items-center justify-center text-white">
                                        <Icon name="mic" size={16} className="text-white"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
                
                // STEP 3: Revisar & Enviar
                const Step3 = () => (
                    <div className="bg-white p-8 rounded-2xl shadow-xl border border-gray-100 max-w-3xl mx-auto animate-fade-in">
                        <h3 className="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><Icon name="check-circle" size={24} className="text-emerald-500"/> 3. Revis√£o Final e Confirma√ß√£o</h3>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 border p-4 rounded-xl bg-gray-50">
                            <div className="space-y-2">
                                <p className="text-sm font-medium text-gray-700 flex items-center gap-2"><Icon name="list" size={16}/> Lista Selecionada:</p>
                                <p className="text-lg font-extrabold text-blue-700">{currentListName}</p>
                                <p className="text-sm text-gray-500">{totalContactsInList} Contatos ser√£o impactados.</p>
                            </div>
                            <div className="space-y-2 border-t md:border-t-0 md:border-l md:pl-4 md:pt-0 pt-4 border-gray-200">
                                <p className="text-sm font-medium text-gray-700 flex items-center gap-2"><Icon name="clock" size={16}/> Configura√ß√£o de Delay:</p>
                                <p className="text-lg font-extrabold text-emerald-700">15s - 45s (Seguro)</p>
                                <p className="text-sm text-gray-500">{mediaAttached ? 'Com' : 'Sem'} Anexo, {salutationVar} ativo.</p>
                            </div>
                        </div>
                        
                        <div className="mb-8 p-4 border border-blue-400 bg-blue-50 rounded-xl">
                            <h4 className="font-semibold mb-2 text-blue-800">Mensagem de Exemplo:</h4>
                            <p className="text-sm text-gray-800 italic">
                                {getPreviewText()}
                            </p>
                        </div>

                        <div className="flex flex-col lg:flex-row justify-between gap-4">
                            <button
                                onClick={() => setCampaignStep(2)}
                                className="px-6 py-3 rounded-full font-medium text-gray-600 flex items-center justify-center gap-2 transition border border-gray-300 hover:bg-gray-100"
                            >
                                <Icon name="arrow-left" size={18}/> Editar Mensagem
                            </button>
                            <button 
                                onClick={() => {
                                    startCampaign(); // Simula√ß√£o de envio
                                    setIsSending(true);
                                }}
                                disabled={isSending || totalContactsInList === 0}
                                className={`lg:w-1/2 py-3 rounded-full font-bold text-white transition shadow-lg ${isSending || totalContactsInList === 0 ? 'bg-gray-400 cursor-not-allowed' : 'bg-emerald-600 hover:bg-emerald-700 hover:shadow-xl'}`}
                            >
                                <Icon name="rocket" size={18}/> CONFIRMAR & INICIAR DISPARO
                            </button>
                        </div>
                    </div>
                );


                return (
                    <div className="flex flex-col h-full">
                        <StepIndicator />
                        <div className="flex-1">
                            {campaignStep === 1 && <Step1 />}
                            {campaignStep === 2 && <Step2 />}
                            {campaignStep === 3 && <Step3 />}
                        </div>
                    </div>
                );
            };


            // 4. CONTATOS (Listas e Tabela Integradas)
            const ContactsList = () => (
                <div className="grid grid-cols-1 lg:grid-cols-5 gap-6 h-full animate-fade-in">
                    
                    {/* Painel de Listas (Col-span 2) */}
                    <div className="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden lg:col-span-2 flex flex-col">
                        <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                            <h4 className="font-bold text-gray-800 text-xl">Grupos de Disparo ({contactLists.length})</h4>
                             <button 
                                className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-full text-sm font-medium transition flex items-center gap-2 shadow-md"
                                onClick={() => setIsCreateListModalOpen(true)} // NOVO: Abre o modal de cria√ß√£o
                             >
                                <Icon name="list-plus" size={16}/> Nova Lista
                            </button>
                        </div>
                        <div className="flex-1 overflow-y-auto divide-y divide-gray-100">
                            {contactLists.map(list => (
                                <div key={list.id} className="p-4 hover:bg-gray-50 cursor-pointer transition flex justify-between items-center group">
                                    <div>
                                        <p className="font-medium text-gray-700">{list.name}</p>
                                        <p className="text-xs text-gray-500">{list.contactIds.length} contatos</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            title="Gerenciar Lista"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                openListManagementModal(list);
                                            }}
                                            className="p-1.5 rounded-full text-blue-500 hover:bg-blue-100 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity"
                                        >
                                            <Icon name="settings" size={18}/>
                                        </button>
                                        <button 
                                            title="Tornar esta a lista ATIVA"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setSelectedListId(list.id);
                                                showModal("Lista Ativa", `A lista '${list.name}' agora √© a lista de disparo ATIVA.`);
                                            }}
                                            className={`p-1.5 rounded-full ${list.id == selectedListId ? 'text-emerald-500' : 'text-gray-400 hover:bg-gray-200'}`}
                                        >
                                            <Icon name="check" size={18}/>
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="p-4 border-t border-gray-100 bg-gray-50 text-sm">
                            <p className="text-gray-500">Contatos √önicos na Base: <span className='font-bold text-gray-800'>{getUniqueContactCount()}</span></p>
                        </div>
                    </div>

                    {/* Tabela de Contatos (Col-span 3) */}
                    <div className="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden flex flex-col lg:col-span-3">
                        <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-white">
                            <h3 className="font-bold text-gray-800 text-xl">Base de Dados Mestra</h3>
                            <div className="flex flex-wrap gap-3">
                                {/* BOT√ÉO DE COLAR EM MASSA */}
                                <button 
                                    onClick={() => setIsBulkPasteModalOpen(true)}
                                    className="text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-full text-sm font-medium transition flex items-center gap-2 border border-blue-200 shadow-md"
                                >
                                    <Icon name="clipboard-copy" size={16}/> Colar em Massa
                                </button>

                                {/* BOT√ÉO DE DOWNLOAD DO MODELO */}
                                <button onClick={downloadTemplate} className="text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-full text-sm font-medium transition flex items-center gap-2 border border-gray-300 shadow-md">
                                    <Icon name="file-text" size={16}/> Baixar Modelo CSV
                                </button>
                                
                                <label className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-full text-sm font-medium cursor-pointer transition flex items-center gap-2 shadow-md">
                                    <Icon name="upload" size={16}/> Importar CSV
                                    <input type="file" accept=".csv" className="hidden" onChange={handleFileUpload}/>
                                </label>
                            </div>
                        </div>
                        
                        <div className="overflow-auto flex-1">
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-gray-50 text-gray-500 text-xs uppercase sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th className="p-4 font-semibold">Nome</th>
                                        <th className="p-4 font-semibold">N√∫mero</th>
                                        <th className="p-4 font-semibold text-center hidden sm:table-cell">Envios (Total)</th>
                                        <th className="p-4 font-semibold">Status</th>
                                        <th className="p-4 font-semibold">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100 text-sm">
                                    {contacts.map(contact => (
                                        <tr key={contact.id} className="hover:bg-gray-50 transition">
                                            <td className="p-4 font-medium text-gray-800 cursor-pointer hover:text-blue-600 hover:underline" onClick={() => openContactDetail(contact)}>{contact.name}</td>
                                            <td className="p-4 text-gray-600 font-mono">{contact.number}</td>
                                            <td className="p-4 text-center hidden sm:table-cell">
                                                <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">{contact.sentYear}</span>
                                            </td>
                                            <td className="p-4">
                                                <span className={`px-3 py-1 rounded-full text-xs font-medium ${
                                                    contact.status === 'Ativo' ? 'bg-green-100 text-green-700' : 
                                                    contact.status === 'Risco' ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-700'
                                                }`}>
                                                    {contact.status}
                                                </span>
                                            </td>
                                            <td className="p-4 flex gap-2">
                                                <button className="p-1 text-gray-400 hover:text-blue-500 rounded-full hover:bg-blue-50" title="Ver Conversa"><Icon name="message-square" size={16}/></button>
                                                <button className="p-1 text-gray-400 hover:text-red-500 rounded-full hover:bg-red-50" title="Excluir Contato" onClick={() => window.deleteDoc(doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/contacts`, contact.id)) }><Icon name="trash-2" size={16}/></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {contacts.length === 0 && (
                                <div className="p-10 text-center text-gray-400">
                                    <Icon name="list-x" size={32} className="mx-auto mb-3"/>
                                    <p>Nenhum contato na base. Importe um CSV para come√ßar.</p>
                                
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );

            // 5. INBOX (Visualmente mais WhatsApp Web-like)
            const Inbox = () => (
                <div className="flex h-full bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden animate-fade-in">
                    
                    {/* Lista de Chats (Sidebar) */}
                    <div className="w-full md:w-1/3 border-r border-gray-200 flex flex-col">
                        <div className="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center sticky top-0 z-10">
                            <h4 className="font-bold text-gray-800">Inbox Centralizada</h4>
                            <div className="flex gap-4 text-gray-500">
                                <Icon name="settings" size={20} className="hover:text-gray-700 cursor-pointer" title="Configura√ß√µes do Inbox"/>
                            </div>
                        </div>
                        <div className="p-2 border-b border-gray-100">
                            <div className="bg-gray-100 p-2 rounded-xl flex items-center gap-2 text-gray-500 text-sm shadow-inner">
                                <Icon name="search" size={16} />
                                <input placeholder="Buscar conversa" className="bg-transparent outline-none w-full" />
                            </div>
                        </div>
                        <div className="overflow-y-auto flex-1 divide-y divide-gray-100">
                            {chats.map(chat => (
                                <div 
                                    key={chat.id} 
                                    onClick={() => {
                                        setSelectedChat(chat);
                                        // Simula√ß√£o: Carregar mensagens do chat
                                        setCurrentChatMessages([
                                            { id: 1, text: `Ol√°, ${chat.name.split(' ')[0]}. Gostaria de saber sobre a campanha.`, sender: chat.name, time: '09:00', status: 'received' },
                                            { id: 2, text: chat.lastMsg, sender: 'Eu', time: chat.time, status: 'sent' },
                                        ]);
                                        setMessageInput('');
                                    }}
                                    className={`p-3 flex gap-3 hover:bg-gray-50 cursor-pointer transition-colors ${selectedChat?.id === chat.id ? 'bg-blue-50 border-l-4 border-blue-500' : ''}`}
                                >
                                    <div className="w-12 h-12 rounded-full bg-gray-200 flex-shrink-0 overflow-hidden">
                                        <img src={`https://i.pravatar.cc/150?u=chat${chat.id}`} className="rounded-full w-full h-full object-cover" alt="Avatar" />
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex justify-between items-start">
                                            <h4 className="font-semibold text-gray-800 truncate text-base">{chat.name}</h4>
                                            <span className="text-xs text-gray-400">{chat.time}</span>
                                        </div>
                                        <div className="flex justify-between items-center mt-1">
                                            <p className="text-sm text-gray-500 truncate">{chat.lastMsg}</p>
                                            {chat.unread > 0 && (
                                                <div className="self-center flex-shrink-0">
                                                    <span className="bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[18px] text-center block">{chat.unread}</span>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Janela do Chat (Main Area) - AGORA INTERATIVO */}
                    <div className="hidden md:flex flex-1 flex-col bg-[#efeae2]">
                        {selectedChat ? (
                            <>
                                <div className="bg-[#f0f2f5] p-3 flex items-center gap-3 border-b border-gray-200 shadow-sm">
                                    <div className="w-10 h-10 rounded-full bg-gray-300 overflow-hidden flex-shrink-0">
                                        <img src={`https://i.pravatar.cc/150?u=chat${selectedChat.id}`} alt="Avatar" className="w-full h-full object-cover" />
                                    </div>
                                    <div className="flex-1">
                                        <h4 className="font-semibold text-gray-800">{selectedChat.name}</h4>
                                        <p className="text-xs text-green-600 font-bold">AGENTE DISPON√çVEL</p>
                                    </div>
                                    <Icon name="archive" className="text-gray-500 cursor-pointer hover:text-gray-700" title="Arquivar Chat"/>
                                </div>
                                
                                {/* √Årea de Mensagens Reais */}
                                <div className="flex-1 p-8 overflow-y-auto chat-bg flex flex-col gap-3">
                                    {currentChatMessages.map(msg => (
                                        <div 
                                            key={msg.id} 
                                            className={`max-w-[60%] px-3 py-2 rounded-xl shadow-md text-sm ${msg.sender === 'Eu' 
                                                ? 'self-end bg-[#d9fdd3] rounded-tr-none' 
                                                : 'self-start bg-white rounded-tl-none'
                                            }`}
                                        >
                                            {msg.text}
                                            <span className={`text-[10px] block mt-1 ${msg.sender === 'Eu' ? 'text-gray-500 text-right' : 'text-gray-400 text-left'}`}>
                                                {msg.time} {msg.sender === 'Eu' && <Icon name="check-check" size={12} className="text-blue-500 inline-block ml-1"/>}
                                            </span>
                                        </div>
                                    ))}
                                </div>

                                {/* Input de Resposta */}
                                <div className="bg-[#f0f2f5] p-3 flex gap-3 items-center border-t border-gray-200">
                                    <input 
                                        className="flex-1 rounded-full border-none py-2 px-4 focus:outline-none text-sm shadow-inner" 
                                        placeholder="Digite sua resposta"
                                        value={messageInput}
                                        onChange={(e) => setMessageInput(e.target.value)}
                                        onKeyPress={(e) => {
                                            if (e.key === 'Enter') handleSendMessage();
                                        }}
                                    />
                                    <button 
                                        onClick={handleSendMessage}
                                        className="bg-emerald-600 w-10 h-10 rounded-full flex items-center justify-center text-white cursor-pointer hover:bg-emerald-700 shadow-lg"
                                    >
                                        <Icon name="send" size={20} />
                                    </button>
                                </div>
                            </>
                        ) : (
                            <div className="h-full flex flex-col items-center justify-center text-gray-500 border-b-8 border-emerald-500 bg-[#f0f2f5] p-8">
                                <Icon name="layout-dashboard" size={80} className="text-gray-400 mb-6"/>
                                <h2 className="text-2xl font-light text-gray-600 mb-2">Selecione uma Conversa</h2>
                                <p className="text-sm text-center max-w-sm">
                                    Interaja com seus clientes em tempo real.
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            );

            // --- RENDER DO LAYOUT PRINCIPAL (Com Header Horizontal) ---
            return (
                <div className="flex flex-col h-screen overflow-hidden">
                    <Modal 
                        title={modalContent.title}
                        message={modalContent.message}
                        isOpen={isModalOpen}
                        onClose={() => setIsModalOpen(false)}
                    />
                    <ContactDetailModal
                        contact={selectedContactDetail}
                        isOpen={!!selectedContactDetail}
                        onClose={() => setSelectedContactDetail(null)}
                    />
                    
                    {/* MODAL DE GERENCIAMENTO DE LISTA */}
                    <ListManagementModal
                        list={selectedListToManage}
                        contacts={contacts}
                        isOpen={!!selectedListToManage}
                        onClose={() => setSelectedListToManage(null)}
                        onListDelete={(deletedId) => setContactLists(prev => prev.filter(l => l.id !== deletedId))}
                    />

                    {/* MODAL DE CRIA√á√ÉO DE LISTA */}
                    <CreateListModal
                        isOpen={isCreateListModalOpen}
                        onClose={() => setIsCreateListModalOpen(false)}
                        onCreate={handleCreateNewList}
                    />

                    {/* MODAL DE PR√â-VISUALIZA√á√ÉO DE IMPORTA√á√ÉO (NOVO) */}
                    {isImportModalOpen && (
                        <ImportPreviewModal
                            stagedData={stagedContacts}
                            contactLists={contactLists}
                            isOpen={isImportModalOpen}
                            onClose={() => setIsImportModalOpen(false)}
                            onConfirmImport={handleConfirmImport}
                        />
                    )}
                    
                    {/* MODAL DE COLAR EM MASSA (NOV√çSSIMO) */}
                    {isBulkPasteModalOpen && (
                        <BulkPasteModal
                            contactLists={contactLists}
                            isOpen={isBulkPasteModalOpen}
                            onClose={() => setIsBulkPasteModalOpen(false)}
                            onConfirmImport={handleConfirmImport}
                        />
                    )}

                    {/* NOVO: BANNER DE AVISO DE SA√öDE CR√çTICO */}
                    <HealthWarningBanner />


                    {/* Header Principal (Navega√ß√£o Horizontal) */}
                    <header className="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-md z-20 sticky top-0">
                        
                        {/* Logo / Bot√£o de Dashboard */}
                        <div 
                            className="flex items-center cursor-pointer transition transform hover:scale-[1.02]"
                            onClick={() => setActiveTab('dashboard')} 
                        >
                            <div className="w-8 h-8 bg-emerald-600 rounded-xl flex items-center justify-center mr-3 shadow-md">
                                <Icon name="zap" size={20} className="text-white"/>
                            </div>
                            <span className="font-extrabold text-xl text-gray-900">ZapFlow <span className="text-emerald-600">Pro V2</span></span>
                        </div>

                        {/* Menu de Navega√ß√£o */}
                        <nav className="hidden md:flex items-center space-x-1">
                            {[
                                { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
                                { id: 'contacts', label: 'Contatos', icon: 'users' },
                                { id: 'campaign', label: 'Campanha', icon: 'rocket' },
                                { id: 'inbox', label: 'Inbox', icon: 'message-square' },
                                { id: 'connect', label: 'Conex√£o', icon: 'qr-code' },
                            ].map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setActiveTab(item.id)}
                                    className={`flex items-center p-2.5 rounded-full text-sm font-medium transition-colors ${
                                        activeTab === item.id 
                                        ? 'bg-blue-100 text-blue-700 shadow-inner' 
                                        : 'text-gray-600 hover:bg-gray-100'
                                    }`}
                                >
                                    <Icon name={item.icon} size={18} />
                                    <span className="ml-2 hidden lg:inline">{item.label}</span>
                                </button>
                            ))}
                        </nav>

                        {/* Status e Perfil */}
                        <div className="flex items-center gap-4">
                            <div className={`flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold transition-all ${isConnected ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                <div className={`w-2.5 h-2.5 rounded-full ${isConnected ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                                {isConnected ? 'ONLINE' : 'OFFLINE'}
                            </div>
                            <div className="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center cursor-pointer hover:bg-slate-300">
                                <Icon name="user" size={16} className="text-gray-700"/>
                            </div>
                        </div>
                    </header>

                    {/* Main Content Area */}
                    <main className="flex-1 p-6 overflow-auto bg-[#f8fafc]">
                        <div className="h-full">
                            {activeTab === 'dashboard' && <Dashboard />}
                            {activeTab === 'connect' && <Connection />}
                            {activeTab === 'contacts' && <ContactsList />}
                            {activeTab === 'campaign' && <Campaign />}
                            {activeTab === 'inbox' && <Inbox />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
