<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disparador PRO - Sistema de Automação WhatsApp</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .whatsapp-bg { background-color: #e5ddd5; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); opacity: 0.9; }
        .chat-bubble { position: relative; max-width: 80%; padding: 10px; border-radius: 8px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .chat-bubble::after { content: ''; position: absolute; top: 0; width: 0; height: 0; }
        .bubble-out { background: #dcf8c6; align-self: flex-end; border-top-right-radius: 0; margin-left: auto; }
        .bubble-out::after { right: -10px; top: 0; border-left: 10px solid #dcf8c6; border-bottom: 10px solid transparent; }
        
        /* Scrollbar customizada */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-scale-in { animation: scaleIn 0.2s ease-out; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONFIGURAÇÃO DA EVOLUTION API (ATUALIZADO) ---
        // ATUALIZE A URL ABAIXO PARA O SEU ENDEREÇO PÚBLICO COM HTTPS
        const API_URL = "https://api.disparadorpro.com"; 
        const API_KEY = "BQYHJGJHJ";             // <--- SUA CHAVE DO ARQUIVO .ENV
        const INSTANCE_NAME = "disparador_pro";  // Nome da sessão

        // --- Componentes de Ícone (Wrapper para Lucide) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- Dados Mockados Iniciais ---
        const MOCK_CONTACTS = [
            { id: 1, name: "Teste 1", phone: "5547999999999", status: "online" }, 
            { id: 2, name: "Teste 2", phone: "5547988888888", status: "offline" },
        ];

        // --- Componente Principal ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [contacts, setContacts] = useState(MOCK_CONTACTS);
            const [connected, setConnected] = useState(false);
            
            // Estado para a campanha
            const [messageTemplate, setMessageTemplate] = useState("Olá {{nome}}, tudo bem? Temos uma oferta especial para você hoje!");
            const [campaignDelay, setCampaignDelay] = useState(10); // segundos
            const [isSending, setIsSending] = useState(false);
            const [progress, setProgress] = useState(0);
            
            // Log de atividades
            const [logs, setLogs] = useState([]);

            // Verifica conexão ao abrir o app
            useEffect(() => {
                checkConnection();
            }, []);

            const checkConnection = async () => {
                try {
                    // USO DA NOVA API_URL
                    const response = await fetch(`${API_URL}/instance/connectionState/${INSTANCE_NAME}`, {
                        method: 'GET',
                        headers: { 'apikey': API_KEY }
                    });
                    const data = await response.json();
                    if (data.instance && data.instance.state === 'open') {
                        setConnected(true);
                    } else {
                        setConnected(false);
                    }
                } catch (error) {
                    console.error("Erro ao verificar conexão. O servidor está rodando?", error);
                    setConnected(false);
                }
            };

            // Simulação de IA / Health Score
            const healthScore = useMemo(() => {
                let score = 100;
                let risk = "Baixo";
                let color = "text-green-500";
                
                if (campaignDelay < 5) { score -= 40; risk = "Crítico"; color = "text-red-600"; }
                else if (campaignDelay < 15) { score -= 20; risk = "Moderado"; color = "text-yellow-500"; }
                
                if (contacts.length > 50 && campaignDelay < 20) { score -= 15; }
                if (messageTemplate.length < 10) { score -= 10; }

                return { score: Math.max(0, score), risk, color };
            }, [campaignDelay, contacts.length, messageTemplate]);

            // --- FUNÇÃO DE DISPARO REAL ---
            const startCampaign = async () => {
                if (!connected) {
                    alert("Por favor, conecte o WhatsApp primeiro (Vá em Conexão).");
                    setActiveTab('connection');
                    return;
                }
                
                setIsSending(true);
                setProgress(0);
                
                let sentCount = 0;
                const total = contacts.length;

                for (let i = 0; i < total; i++) {
                    const contact = contacts[i];
                    
                    // 1. Processar Variáveis
                    let finalMessage = messageTemplate.replace(/{{nome}}/gi, contact.name);

                    // 2. Limpar número (deixar apenas dígitos)
                    let cleanPhone = contact.phone.replace(/\D/g, '');

                    try {
                        // 3. Enviar Requisição para a API (USO DA NOVA API_URL)
                        const response = await fetch(`${API_URL}/message/sendText/${INSTANCE_NAME}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': API_KEY
                            },
                            body: JSON.stringify({
                                number: cleanPhone,
                                text: finalMessage,
                                delay: 1200,
                                linkPreview: true
                            })
                        });

                        const result = await response.json();
                        
                        // Log
                        if (response.status === 201 || result.key) {
                             setLogs(prev => [{ time: new Date().toLocaleTimeString(), action: `Enviado para ${contact.name}`, type: 'success' }, ...prev]);
                        } else {
                             throw new Error(result.message || "Erro desconhecido");
                        }

                    } catch (error) {
                        console.error("Erro no envio:", error);
                        setLogs(prev => [{ time: new Date().toLocaleTimeString(), action: `Erro ao enviar para ${contact.name}`, type: 'error' }, ...prev]);
                    }

                    // 4. Atualizar Progresso
                    sentCount++;
                    setProgress((sentCount / total) * 100);

                    // 5. Aguardar o Delay (Delay Real)
                    if (i < total - 1) {
                        await new Promise(resolve => setTimeout(resolve, campaignDelay * 1000));
                    }
                }

                setIsSending(false);
                alert("Campanha finalizada!");
            };

            const renderContent = () => {
                switch(activeTab) {
                    case 'dashboard': return <Dashboard stats={{ contacts: contacts.length }} logs={logs} connected={connected} />;
                    case 'connection': return <Connection connected={connected} setConnected={setConnected} />;
                    case 'contacts': return <ContactsManager contacts={contacts} setContacts={setContacts} />;
                    case 'campaign': return (
                        <CampaignBuilder 
                            template={messageTemplate} 
                            setTemplate={setMessageTemplate}
                            contacts={contacts}
                            delay={campaignDelay}
                            setDelay={setCampaignDelay}
                            health={healthScore}
                            onSend={startCampaign}
                            isSending={isSending}
                            progress={progress}
                        />
                    );
                    case 'chat': return <UnifiedChat contacts={contacts} />;
                    default: return <Dashboard />;
                }
            };

            return (
                <div className="flex h-screen w-full bg-gray-100 text-gray-800 overflow-hidden">
                    {/* Sidebar */}
                    <aside className="w-20 lg:w-64 bg-white border-r border-gray-200 flex flex-col justify-between transition-all duration-300 z-20 shadow-sm">
                        <div>
                            <div 
                                className="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors"
                                onClick={() => setActiveTab('dashboard')}
                            >
                                <div className="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center text-white font-bold mr-0 lg:mr-3 shadow-lg shadow-green-200">
                                    D
                                </div>
                                <span className="font-bold text-xl hidden lg:block text-gray-800 tracking-tight">Disparador<span className="text-green-600">Pro</span></span>
                            </div>
                            <nav className="mt-6 flex flex-col gap-2 px-3">
                                <SidebarItem icon="layout-dashboard" label="Dashboard Geral" active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} />
                                <SidebarItem icon="smartphone" label="Conexão & Status" active={activeTab === 'connection'} onClick={() => setActiveTab('connection')} />
                                <SidebarItem icon="users" label="Gerenciar Contatos" active={activeTab === 'contacts'} onClick={() => setActiveTab('contacts')} />
                                <SidebarItem icon="message-square" label="Chats Unificados" active={activeTab === 'chat'} onClick={() => setActiveTab('chat')} />
                                <SidebarItem icon="send" label="Criar Campanha" active={activeTab === 'campaign'} onClick={() => setActiveTab('campaign')} />
                            </nav>
                        </div>
                        <div className="p-4 border-t border-gray-100">
                            <div className={`flex items-center gap-3 p-3 rounded-xl transition-colors ${connected ? 'bg-green-50 border border-green-100' : 'bg-red-50 border border-red-100'}`}>
                                <div className={`w-3 h-3 rounded-full ${connected ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]' : 'bg-red-500'} animate-pulse`}></div>
                                <div className="hidden lg:block">
                                    <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Status do Sistema</p>
                                    <p className={`text-sm font-bold ${connected ? 'text-green-700' : 'text-red-700'}`}>
                                        {connected ? 'Conectado' : 'Offline'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 overflow-auto bg-[#F8FAFC] p-4 lg:p-8">
                        {renderContent()}
                    </main>
                </div>
            );
        };

        // --- Sub-Componentes ---

        const SidebarItem = ({ icon, label, active, onClick }) => (
            <button 
                onClick={onClick}
                className={`flex items-center w-full p-3 rounded-lg transition-all duration-200 group relative overflow-hidden
                    ${active ? 'bg-green-50 text-green-700 shadow-sm ring-1 ring-green-100' : 'text-gray-500 hover:bg-white hover:shadow-sm hover:text-gray-700'}`}
            >
                <Icon name={icon} className={`${active ? 'stroke-green-600' : 'stroke-gray-400 group-hover:stroke-gray-600'} transition-colors relative z-10`} />
                <span className="ml-3 font-medium hidden lg:block text-sm relative z-10">{label}</span>
                {active && <div className="absolute left-0 top-0 bottom-0 w-1 bg-green-500 rounded-r-full"></div>}
            </button>
        );

        // --- COMPONENTE DE CONEXÃO ATUALIZADO ---
        const Connection = ({ connected, setConnected }) => {
            const [qrCodeBase64, setQrCodeBase64] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState("");

            // Função para gerar o QR Code
            const handleConnect = async () => {
                setIsLoading(true);
                setErrorMsg("");
                setQrCodeBase64(null);

                try {
                    // 1. Tenta criar a instância
                    const response = await fetch(`${API_URL}/instance/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': API_KEY
                        },
                        body: JSON.stringify({
                            instanceName: INSTANCE_NAME,
                            qrcode: true
                        })
                    });
                    
                    const data = await response.json();

                    // Se a instância já existe (403), tentamos pegar o status ou conectar
                    if (data.status === 403 || (data.error && data.error.includes("already exists"))) {
                        // Tenta conectar para pegar o QR se estiver desconectada
                        const connectResp = await fetch(`${API_URL}/instance/connect/${INSTANCE_NAME}`, {
                            method: 'GET', 
                            headers: { 'apikey': API_KEY }
                        });
                         const connectData = await connectResp.json();
                         if(connectData.base64) {
                             setQrCodeBase64(connectData.base64);
                         } else {
                             alert("A instância já existe e parece estar conectada ou com erro. Tente desconectar primeiro.");
                         }
                    } else if (data.base64) {
                        setQrCodeBase64(data.base64);
                    } else if (data.instance && data.instance.state === 'open') {
                        setConnected(true);
                    }

                    // Inicia monitoramento
                    startMonitoring();

                } catch (error) {
                    console.error(error);
                    setErrorMsg("Erro ao conectar com a API. Verifique se o servidor da API está rodando e acessível.");
                } finally {
                    setIsLoading(false);
                }
            };

            const handleDisconnect = async () => {
                if(!confirm("Tem certeza que deseja desconectar?")) return;
                try {
                     await fetch(`${API_URL}/instance/logout/${INSTANCE_NAME}`, {
                        method: 'DELETE',
                        headers: { 'apikey': API_KEY }
                    });
                    setConnected(false);
                    setQrCodeBase64(null);
                } catch(e) { console.error(e); }
            };

            // Monitora se conectou a cada 3 segundos
            const startMonitoring = () => {
                const interval = setInterval(async () => {
                    try {
                        const response = await fetch(`${API_URL}/instance/connectionState/${INSTANCE_NAME}`, {
                            headers: { 'apikey': API_KEY }
                        });
                        const data = await response.json();
                        if (data.instance && data.instance.state === 'open') {
                            setConnected(true);
                            setQrCodeBase64(null);
                            clearInterval(interval);
                        }
                    } catch (e) {}
                }, 3000);
            };

            return (
                <div className="flex flex-col items-center justify-center h-full bg-white rounded-xl shadow-sm border border-gray-100 p-8 text-center animate-fade-in">
                    <h2 className="text-2xl font-bold mb-2">Conectar WhatsApp</h2>
                    <p className="text-gray-500 mb-8 max-w-md">Gerencie a conexão da sua instância <strong>{INSTANCE_NAME}</strong>.</p>
                    
                    {connected ? (
                        <div className="flex flex-col items-center animate-fade-in">
                            <div className="relative">
                                <div className="absolute inset-0 bg-green-200 rounded-full animate-ping opacity-20"></div>
                                <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-4 relative z-10">
                                    <Icon name="check" size={48} className="stroke-green-600" />
                                </div>
                            </div>
                            <h3 className="text-xl font-bold text-green-700">Conectado com Sucesso!</h3>
                            <p className="text-gray-500 mt-2 mb-6">Seu sistema está pronto para disparar.</p>
                            
                            <button 
                                onClick={handleDisconnect}
                                className="px-6 py-2 border border-red-200 text-red-600 rounded-lg hover:bg-red-50 text-sm font-medium transition-colors"
                            >
                                Desconectar Sessão
                            </button>
                        </div>
                    ) : (
                        <div className="flex flex-col items-center">
                            {!qrCodeBase64 ? (
                                <div className="flex flex-col items-center gap-4">
                                    <div className="p-6 bg-gray-50 rounded-xl border border-gray-100">
                                        <Icon name="qr-code" size={64} className="stroke-gray-300" />
                                    </div>
                                    {errorMsg && <p className="text-red-500 text-sm">{errorMsg}</p>}
                                    <button 
                                        onClick={handleConnect}
                                        disabled={isLoading}
                                        className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition-colors flex items-center gap-2 shadow-lg shadow-green-200"
                                    >
                                        {isLoading ? <Icon name="loader-2" className="animate-spin" /> : <Icon name="power" />}
                                        {isLoading ? "Gerando..." : "Gerar QR Code"}
                                    </button>
                                </div>
                            ) : (
                                <div className="flex flex-col items-center animate-fade-in">
                                    <p className="text-sm font-bold text-gray-700 mb-2">Leia o código no seu app do WhatsApp:</p>
                                    <div className="p-2 bg-white border-2 border-gray-900 rounded-lg shadow-xl">
                                        <img src={qrCodeBase64} alt="QR Code" className="w-64 h-64 object-contain" />
                                    </div>
                                    <p className="text-xs text-green-600 mt-4 flex items-center gap-2">
                                        <Icon name="loader-2" size={14} className="animate-spin" />
                                        Aguardando leitura...
                                    </p>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const Dashboard = ({ stats, connected, logs = [] }) => {
            const displayLogs = logs.length > 0 ? logs : [
                { time: "---", action: "Nenhuma atividade recente", type: "info" }
            ];

            return (
                <div className="space-y-6 animate-fade-in pb-10">
                    <header className="flex justify-between items-end">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-800">Visão Geral</h1>
                            <p className="text-gray-500 text-sm">Resumo operacional e métricas de desempenho.</p>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <StatCard icon="users" title="Contatos" value={stats?.contacts || 0} sub="Cadastrados" color="blue" />
                        <StatCard icon="check-circle" title="Status API" value={connected ? "ON" : "OFF"} sub={connected ? "Operacional" : "Desconectado"} color={connected ? "green" : "red"} />
                        <StatCard icon="send" title="Envios" value={logs.length} sub="Nesta sessão" color="purple" />
                        <StatCard icon="clock" title="Economia" value="--:--" sub="Horas estimadas" color="orange" />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h3 className="font-semibold text-gray-800 mb-4">Log de Execução (Tempo Real)</h3>
                            <div className="space-y-4 max-h-60 overflow-y-auto">
                                {displayLogs.map((log, i) => (
                                    <div key={i} className="flex items-start gap-4 pb-4 border-b border-gray-50 last:border-0 last:pb-0">
                                        <div className={`mt-1 w-2 h-2 rounded-full flex-shrink-0 
                                            ${log.type === 'success' ? 'bg-green-500' : 
                                              log.type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`}>
                                        </div>
                                        <div className="flex-1">
                                            <p className="text-sm text-gray-700 font-medium">{log.action}</p>
                                            <p className="text-xs text-gray-400 mt-0.5">{log.time}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const StatCard = ({ icon, title, value, sub, color, onClick }) => {
            const colors = {
                blue: "bg-blue-50 text-blue-600 border-blue-100",
                green: "bg-green-50 text-green-600 border-green-100",
                purple: "bg-purple-50 text-purple-600 border-purple-100",
                orange: "bg-orange-50 text-orange-600 border-orange-100",
                red: "bg-red-50 text-red-600 border-red-100"
            };
            const iconColor = colors[color]?.split(' ')[1] || "text-gray-600";
            
            return (
                <div onClick={onClick} className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 transition-all duration-300 group cursor-pointer relative overflow-hidden">
                    <div className="flex justify-between items-start mb-2 relative z-10">
                        <div className={`p-2.5 rounded-lg ${colors[color] || colors.blue}`}>
                            <Icon name="icon" size={20} className={iconColor} /> {/* Ajuste genérico de ícone se o componente Icon falhar, mas o de cima deve funcionar */}
                            <i data-lucide={icon} className={iconColor}></i>
                        </div>
                    </div>
                    <div className="relative z-10">
                        <p className="text-gray-500 text-xs font-medium uppercase tracking-wide mb-1">{title}</p>
                        <h4 className="text-2xl font-bold text-gray-800">{value}</h4>
                        <p className={`text-xs mt-1 font-medium ${iconColor}`}>{sub}</p>
                    </div>
                </div>
            );
        };

        const ContactsManager = ({ contacts, setContacts }) => {
            const [newName, setNewName] = useState("");
            const [newPhone, setNewPhone] = useState("");

            const addContact = (e) => {
                e.preventDefault();
                if (!newName || !newPhone) return;
                setContacts([...contacts, { id: Date.now(), name: newName, phone: newPhone, status: "offline" }]);
                setNewName("");
                setNewPhone("");
            };

            const removeContact = (id) => {
                setContacts(contacts.filter(c => c.id !== id));
            };

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-800">Meus Contatos</h2>
                        <button className="bg-gray-900 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-gray-800 shadow-lg shadow-gray-200 transition-all active:scale-95">
                            <Icon name="upload" size={16} /> Importar CSV
                        </button>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit sticky top-4">
                            <h3 className="font-semibold mb-4 text-gray-800">Adicionar Manualmente</h3>
                            <form onSubmit={addContact} className="space-y-4">
                                <div>
                                    <label className="text-xs font-medium text-gray-500 block mb-1.5 uppercase">Nome</label>
                                    <div className="relative">
                                        <Icon name="user" size={16} className="absolute left-3 top-3 text-gray-400" />
                                        <input 
                                            type="text" 
                                            value={newName}
                                            onChange={(e) => setNewName(e.target.value)}
                                            className="w-full border border-gray-200 rounded-lg p-2.5 pl-9 focus:ring-2 focus:ring-green-500 outline-none transition-all"
                                            placeholder="Ex: Cliente VIP"
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs font-medium text-gray-500 block mb-1.5 uppercase">WhatsApp</label>
                                    <div className="relative">
                                        <Icon name="phone" size={16} className="absolute left-3 top-3 text-gray-400" />
                                        <input 
                                            type="text" 
                                            value={newPhone}
                                            onChange={(e) => setNewPhone(e.target.value)}
                                            className="w-full border border-gray-200 rounded-lg p-2.5 pl-9 focus:ring-2 focus:ring-green-500 outline-none transition-all"
                                            placeholder="Ex: 5511999999999"
                                        />
                                    </div>
                                </div>
                                <button type="submit" className="w-full bg-green-600 text-white py-2.5 rounded-lg font-bold hover:bg-green-700 shadow-lg shadow-green-100 transition-all flex justify-center gap-2">
                                    <Icon name="plus" size={20} /> Adicionar
                                </button>
                            </form>
                        </div>

                        <div className="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden flex flex-col">
                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead className="bg-gray-50 text-gray-500 text-xs uppercase font-semibold">
                                        <tr>
                                            <th className="p-4 rounded-tl-xl">Nome</th>
                                            <th className="p-4">Telefone</th>
                                            <th className="p-4 text-center rounded-tr-xl">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {contacts.map(contact => (
                                            <tr key={contact.id} className="hover:bg-gray-50 transition-colors group">
                                                <td className="p-4 font-medium text-gray-700 flex items-center gap-3">
                                                    <div className="w-8 h-8 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center text-xs font-bold text-gray-500">
                                                        {contact.name.charAt(0)}
                                                    </div>
                                                    {contact.name}
                                                </td>
                                                <td className="p-4 text-gray-500 text-sm font-mono">{contact.phone}</td>
                                                <td className="p-4 text-center">
                                                    <button onClick={() => removeContact(contact.id)} className="text-gray-300 hover:text-red-500 p-2 transition-colors rounded-full hover:bg-red-50">
                                                        <Icon name="trash-2" size={16} />
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CampaignBuilder = ({ template, setTemplate, contacts, delay, setDelay, health, onSend, isSending, progress }) => {
            const insertVariable = (variable) => {
                setTemplate(prev => prev + ` {{${variable}}} `);
            };

            const previewMessage = useMemo(() => {
                const exampleName = contacts[0]?.name || "Maria Silva";
                return template.replace(/{{nome}}/gi, exampleName);
            }, [template, contacts]);

            return (
                <div className="h-full flex flex-col lg:flex-row gap-6 animate-fade-in">
                    <div className="flex-1 space-y-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h2 className="text-xl font-bold mb-4 text-gray-800">Nova Campanha</h2>
                            
                            {/* Smart Guard Alert */}
                            <div className={`mb-6 p-4 rounded-xl border flex items-start gap-4 transition-colors duration-500 ${health.score > 80 ? 'bg-green-50 border-green-200' : 'bg-orange-50 border-orange-200'}`}>
                                <div className={`p-2 rounded-lg ${health.score > 80 ? 'bg-green-100' : 'bg-orange-100'}`}>
                                    <Icon name="shield-alert" className={health.color} />
                                </div>
                                <div>
                                    <h4 className={`font-bold text-sm flex items-center gap-2 ${health.color}`}>
                                        IA Security Monitor
                                    </h4>
                                    <p className="text-sm text-gray-600 mt-1">
                                        Risco estimado: <strong>{health.risk}</strong> ({health.score}/100).
                                        {health.score < 80 ? ' Aumente o delay entre mensagens para evitar bloqueios.' : ' Configuração segura.'}
                                    </p>
                                </div>
                            </div>

                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Mensagem</label>
                                <div className="flex gap-2 mb-2 overflow-x-auto pb-2">
                                    <button onClick={() => insertVariable('nome')} className="px-3 py-1.5 bg-gray-50 text-xs font-medium text-gray-600 rounded-lg hover:bg-gray-100 border border-gray-200 transition-colors flex items-center gap-1">
                                        <Icon name="plus" size={12} /> Nome
                                    </button>
                                </div>
                                <textarea 
                                    className="w-full h-40 p-4 border border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent outline-none resize-none text-sm text-gray-600 leading-relaxed shadow-inner"
                                    value={template}
                                    onChange={(e) => setTemplate(e.target.value)}
                                    placeholder="Digite sua mensagem aqui..."
                                ></textarea>
                                <div className="text-right text-xs text-gray-400 mt-1">{template.length} caracteres</div>
                            </div>

                            <div className="grid grid-cols-2 gap-4 mb-8">
                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 mb-1.5 uppercase">Delay (segundos)</label>
                                    <div className="relative">
                                        <Icon name="clock" size={16} className="absolute left-3 top-3 text-gray-400" />
                                        <input 
                                            type="number" 
                                            value={delay}
                                            onChange={(e) => setDelay(parseInt(e.target.value) || 0)}
                                            className="w-full p-2.5 pl-9 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition-all"
                                        />
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-xs font-semibold text-gray-500 mb-1.5 uppercase">Alcance</label>
                                    <div className="w-full p-2.5 bg-gray-50 border border-gray-100 rounded-lg text-gray-600 flex items-center gap-2">
                                        <Icon name="users" size={16} className="text-gray-400" />
                                        <span className="font-medium">{contacts.length}</span> <span className="text-xs">contatos</span>
                                    </div>
                                </div>
                            </div>

                            {isSending ? (
                                <div className="space-y-3 bg-gray-50 p-4 rounded-xl border border-gray-100">
                                    <div className="flex justify-between text-xs font-bold text-gray-600">
                                        <span className="flex items-center gap-2"><Icon name="loader" size={14} className="animate-spin" /> Enviando campanha...</span>
                                        <span>{Math.round(progress)}%</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                        <div 
                                            className="bg-green-500 h-3 rounded-full transition-all duration-300 relative overflow-hidden" 
                                            style={{ width: `${progress}%` }}
                                        ></div>
                                    </div>
                                    <p className="text-center text-xs text-gray-400">Não feche esta janela.</p>
                                </div>
                            ) : (
                                <button 
                                    onClick={onSend}
                                    className="w-full bg-green-600 text-white py-4 rounded-xl font-bold hover:bg-green-700 shadow-xl shadow-green-200 hover:shadow-green-300 hover:-translate-y-1 transition-all flex items-center justify-center gap-2 group"
                                >
                                    <Icon name="rocket" size={20} className="group-hover:animate-bounce" />
                                    Iniciar Disparos
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Preview Phone */}
                    <div className="w-full lg:w-80 flex-shrink-0 flex justify-center items-start pt-4">
                        <div className="w-[300px] h-[600px] bg-black rounded-[3rem] p-3 shadow-2xl relative border-4 border-gray-800 ring-4 ring-gray-100/50">
                            <div className="absolute top-0 left-1/2 transform -translate-x-1/2 w-32 h-6 bg-black rounded-b-xl z-20"></div>
                            <div className="w-full h-full bg-white rounded-[2.2rem] overflow-hidden flex flex-col relative z-10 whatsapp-bg">
                                <div className="bg-[#075e54] h-16 flex items-end pb-2 px-4 text-white shadow-md">
                                    <div className="flex items-center gap-2">
                                        <Icon name="arrow-left" size={20} />
                                        <div className="w-8 h-8 rounded-full bg-gray-300 overflow-hidden flex items-center justify-center bg-white">
                                            <Icon name="user" className="stroke-gray-600 w-5 h-5" />
                                        </div>
                                        <div className="flex-1">
                                            <span className="font-semibold text-sm block leading-tight">{contacts[0]?.name || "Cliente"}</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex-1 p-4 overflow-y-auto flex flex-col gap-3">
                                    <div className="chat-bubble bg-white text-sm self-start shadow-sm text-gray-800">
                                        Olá! Tudo bem?
                                        <span className="text-[10px] text-gray-400 block text-right mt-1">10:00</span>
                                    </div>
                                    <div className="chat-bubble bubble-out text-sm text-gray-800 shadow-sm">
                                        {previewMessage}
                                        <span className="text-[10px] text-gray-500 block text-right mt-1 flex items-center justify-end gap-1">
                                            10:02 <Icon name="check-check" size={14} className="stroke-blue-500" />
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const UnifiedChat = ({ contacts }) => {
            const [selectedChat, setSelectedChat] = useState(contacts[0]?.id);
            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-100 h-[calc(100vh-140px)] flex items-center justify-center text-gray-400">
                    <p>Funcionalidade de Chat (Em desenvolvimento)</p>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
